"use strict";function _classCallCheck(r,n){if(!(r instanceof n))throw new TypeError("Cannot call a class as a function")}function _defineProperties(r,n){for(var e=0;e<n.length;e++){var t=n[e];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(r,t.key,t)}}function _createClass(r,n,e){return n&&_defineProperties(r.prototype,n),e&&_defineProperties(r,e),r}var mStats,Stats=require("webpack/lib/Stats"),argv=require("yargs").argv,fs=require("fs"),path=require("path"),_require=require("./lite/lite-enum"),DEVICE_LEVEL=_require.DEVICE_LEVEL,REG=/\([^\)]+\)/,mErrorCount=0,mWarningCount=0,isShowError=!0,isShowWarning=!0,isShowNote=!0,warningCount=0,noteCount=0,ResultStates=function(){function r(n){_classCallCheck(this,r),this.options=n}return _createClass(r,[{key:"apply",value:function(r){var n=this.options.build;r.hooks.done.tap("Result States",function(r){warningCount=0,noteCount=0,(mStats=r).compilation.errors&&(mErrorCount=mStats.compilation.errors.length),mStats.compilation.warnings&&(mWarningCount=mStats.compilation.warnings.length),"false"===argv.error&&(isShowError=!1),"false"===argv.warning&&(isShowWarning=!1),"false"===argv.note&&(isShowNote=!1),printResult(n)})}}]),r}(),red="[31m",yellow="[33m",blue="[34m",reset="[39m",writeError=function(r,n){fs.writeFile(path.resolve(r,"compile_error.log"),n,function(r){if(r)return console.error(r)})};function printResult(r){var n=new Stats(mStats.compilation);if(printWarning(n),printError(n,r),mErrorCount+warningCount+noteCount>0){var e,t={};mErrorCount>0?(t.ERROR=mErrorCount,e="FAIL "):e="SUCCESS ",warningCount>0&&(t.WARN=warningCount),noteCount>0&&(t.NOTE=noteCount),console.log(blue,"COMPILE RESULT:"+e+JSON.stringify(t),reset)}else console.log(blue,"COMPILE RESULT:SUCCESS ",reset)}function printWarning(r){if(mWarningCount>0){for(var n=mStats.compilation.warnings,e=n.length,t=0;t<e;t++){var o=n[t].message.replace("(Emitted value instead of an instance of Error) ","");o=o.replace(/Module Warning[^\n]+\n/,"");var i=r.toJson().warnings[t].split("\n")[0].replace(REG,"").trim();/^NOTE:/.test(o)?(noteCount++,isShowNote&&(console.info("NOTE in "+i,reset),console.info(o.replace(/^NOTE:/,""),reset,"\n"))):(warningCount++,isShowWarning&&(console.warn(yellow,"WARNING in "+i,reset),/^WARNING:/.test(o)||(o="WARNING: "+o+"\n"),console.warn(yellow,o.replace(/^WARNING:/,""),reset,"\n")))}mWarningCount>e&&(warningCount=warningCount+mWarningCount-e)}}function printError(r,n){if(mErrorCount>0){var e=mStats.compilation.errors,t=e.length;if(isShowError){for(var o="",i=0;i<t;i++){var a=r.toJson().errors[i].split("\n")[0].replace(REG,"").trim(),s=e[i].message.replace(/Module Error[^\n]+\n/,"").replace("(Emitted value instead of an instance of Error) ","").replace(/^ERROR:/,"");console.error(red,"ERROR in "+a,reset),console.error(red,s,reset,"\n"),o+="ERROR in "+a+"\n"+s+"\n"}writeError(n,o)}}}module.exports=ResultStates;