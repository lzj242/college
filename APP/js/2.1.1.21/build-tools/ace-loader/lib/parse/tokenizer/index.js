"use strict";const Preprocessor=require("./preprocessor"),unicode=require("../common/unicode"),neTree=require("./named-entity-data"),ERR=require("../common/error-codes"),$=unicode.CODE_POINTS,$$=unicode.CODE_POINT_SEQUENCES,C1_CONTROLS_REFERENCE_REPLACEMENTS={128:8364,130:8218,131:402,132:8222,133:8230,134:8224,135:8225,136:710,137:8240,138:352,139:8249,140:338,142:381,145:8216,146:8217,147:8220,148:8221,149:8226,150:8211,151:8212,152:732,153:8482,154:353,155:8250,156:339,158:382,159:376},HAS_DATA_FLAG=1,DATA_DUPLET_FLAG=2,HAS_BRANCHES_FLAG=4,MAX_BRANCH_MARKER_VALUE=HAS_DATA_FLAG|DATA_DUPLET_FLAG|HAS_BRANCHES_FLAG,DATA_STATE="DATA_STATE",RCDATA_STATE="RCDATA_STATE",RAWTEXT_STATE="RAWTEXT_STATE",SCRIPT_DATA_STATE="SCRIPT_DATA_STATE",PLAINTEXT_STATE="PLAINTEXT_STATE",TAG_OPEN_STATE="TAG_OPEN_STATE",END_TAG_OPEN_STATE="END_TAG_OPEN_STATE",TAG_NAME_STATE="TAG_NAME_STATE",RCDATA_LESS_THAN_SIGN_STATE="RCDATA_LESS_THAN_SIGN_STATE",RCDATA_END_TAG_OPEN_STATE="RCDATA_END_TAG_OPEN_STATE",RCDATA_END_TAG_NAME_STATE="RCDATA_END_TAG_NAME_STATE",RAWTEXT_LESS_THAN_SIGN_STATE="RAWTEXT_LESS_THAN_SIGN_STATE",RAWTEXT_END_TAG_OPEN_STATE="RAWTEXT_END_TAG_OPEN_STATE",RAWTEXT_END_TAG_NAME_STATE="RAWTEXT_END_TAG_NAME_STATE",SCRIPT_DATA_LESS_THAN_SIGN_STATE="SCRIPT_DATA_LESS_THAN_SIGN_STATE",SCRIPT_DATA_END_TAG_OPEN_STATE="SCRIPT_DATA_END_TAG_OPEN_STATE",SCRIPT_DATA_END_TAG_NAME_STATE="SCRIPT_DATA_END_TAG_NAME_STATE",SCRIPT_DATA_ESCAPE_START_STATE="SCRIPT_DATA_ESCAPE_START_STATE",SCRIPT_DATA_ESCAPE_START_DASH_STATE="SCRIPT_DATA_ESCAPE_START_DASH_STATE",SCRIPT_DATA_ESCAPED_STATE="SCRIPT_DATA_ESCAPED_STATE",SCRIPT_DATA_ESCAPED_DASH_STATE="SCRIPT_DATA_ESCAPED_DASH_STATE",SCRIPT_DATA_ESCAPED_DASH_DASH_STATE="SCRIPT_DATA_ESCAPED_DASH_DASH_STATE",SCRIPT_DATA_ESCAPED_LESS_THAN_SIGN_STATE="SCRIPT_DATA_ESCAPED_LESS_THAN_SIGN_STATE",SCRIPT_DATA_ESCAPED_END_TAG_OPEN_STATE="SCRIPT_DATA_ESCAPED_END_TAG_OPEN_STATE",SCRIPT_DATA_ESCAPED_END_TAG_NAME_STATE="SCRIPT_DATA_ESCAPED_END_TAG_NAME_STATE",SCRIPT_DATA_DOUBLE_ESCAPE_START_STATE="SCRIPT_DATA_DOUBLE_ESCAPE_START_STATE",SCRIPT_DATA_DOUBLE_ESCAPED_STATE="SCRIPT_DATA_DOUBLE_ESCAPED_STATE",SCRIPT_DATA_DOUBLE_ESCAPED_DASH_STATE="SCRIPT_DATA_DOUBLE_ESCAPED_DASH_STATE",SCRIPT_DATA_DOUBLE_ESCAPED_DASH_DASH_STATE="SCRIPT_DATA_DOUBLE_ESCAPED_DASH_DASH_STATE",SCRIPT_DATA_DOUBLE_ESCAPED_LESS_THAN_SIGN_STATE="SCRIPT_DATA_DOUBLE_ESCAPED_LESS_THAN_SIGN_STATE",SCRIPT_DATA_DOUBLE_ESCAPE_END_STATE="SCRIPT_DATA_DOUBLE_ESCAPE_END_STATE",BEFORE_ATTRIBUTE_NAME_STATE="BEFORE_ATTRIBUTE_NAME_STATE",ATTRIBUTE_NAME_STATE="ATTRIBUTE_NAME_STATE",AFTER_ATTRIBUTE_NAME_STATE="AFTER_ATTRIBUTE_NAME_STATE",BEFORE_ATTRIBUTE_VALUE_STATE="BEFORE_ATTRIBUTE_VALUE_STATE",ATTRIBUTE_VALUE_DOUBLE_QUOTED_STATE="ATTRIBUTE_VALUE_DOUBLE_QUOTED_STATE",ATTRIBUTE_VALUE_SINGLE_QUOTED_STATE="ATTRIBUTE_VALUE_SINGLE_QUOTED_STATE",ATTRIBUTE_VALUE_UNQUOTED_STATE="ATTRIBUTE_VALUE_UNQUOTED_STATE",AFTER_ATTRIBUTE_VALUE_QUOTED_STATE="AFTER_ATTRIBUTE_VALUE_QUOTED_STATE",SELF_CLOSING_START_TAG_STATE="SELF_CLOSING_START_TAG_STATE",BOGUS_COMMENT_STATE="BOGUS_COMMENT_STATE",MARKUP_DECLARATION_OPEN_STATE="MARKUP_DECLARATION_OPEN_STATE",COMMENT_START_STATE="COMMENT_START_STATE",COMMENT_START_DASH_STATE="COMMENT_START_DASH_STATE",COMMENT_STATE="COMMENT_STATE",COMMENT_LESS_THAN_SIGN_STATE="COMMENT_LESS_THAN_SIGN_STATE",COMMENT_LESS_THAN_SIGN_BANG_STATE="COMMENT_LESS_THAN_SIGN_BANG_STATE",COMMENT_LESS_THAN_SIGN_BANG_DASH_STATE="COMMENT_LESS_THAN_SIGN_BANG_DASH_STATE",COMMENT_LESS_THAN_SIGN_BANG_DASH_DASH_STATE="COMMENT_LESS_THAN_SIGN_BANG_DASH_DASH_STATE",COMMENT_END_DASH_STATE="COMMENT_END_DASH_STATE",COMMENT_END_STATE="COMMENT_END_STATE",COMMENT_END_BANG_STATE="COMMENT_END_BANG_STATE",DOCTYPE_STATE="DOCTYPE_STATE",BEFORE_DOCTYPE_NAME_STATE="BEFORE_DOCTYPE_NAME_STATE",DOCTYPE_NAME_STATE="DOCTYPE_NAME_STATE",AFTER_DOCTYPE_NAME_STATE="AFTER_DOCTYPE_NAME_STATE",AFTER_DOCTYPE_PUBLIC_KEYWORD_STATE="AFTER_DOCTYPE_PUBLIC_KEYWORD_STATE",BEFORE_DOCTYPE_PUBLIC_IDENTIFIER_STATE="BEFORE_DOCTYPE_PUBLIC_IDENTIFIER_STATE",DOCTYPE_PUBLIC_IDENTIFIER_DOUBLE_QUOTED_STATE="DOCTYPE_PUBLIC_IDENTIFIER_DOUBLE_QUOTED_STATE",DOCTYPE_PUBLIC_IDENTIFIER_SINGLE_QUOTED_STATE="DOCTYPE_PUBLIC_IDENTIFIER_SINGLE_QUOTED_STATE",AFTER_DOCTYPE_PUBLIC_IDENTIFIER_STATE="AFTER_DOCTYPE_PUBLIC_IDENTIFIER_STATE",BETWEEN_DOCTYPE_PUBLIC_AND_SYSTEM_IDENTIFIERS_STATE="BETWEEN_DOCTYPE_PUBLIC_AND_SYSTEM_IDENTIFIERS_STATE",AFTER_DOCTYPE_SYSTEM_KEYWORD_STATE="AFTER_DOCTYPE_SYSTEM_KEYWORD_STATE",BEFORE_DOCTYPE_SYSTEM_IDENTIFIER_STATE="BEFORE_DOCTYPE_SYSTEM_IDENTIFIER_STATE",DOCTYPE_SYSTEM_IDENTIFIER_DOUBLE_QUOTED_STATE="DOCTYPE_SYSTEM_IDENTIFIER_DOUBLE_QUOTED_STATE",DOCTYPE_SYSTEM_IDENTIFIER_SINGLE_QUOTED_STATE="DOCTYPE_SYSTEM_IDENTIFIER_SINGLE_QUOTED_STATE",AFTER_DOCTYPE_SYSTEM_IDENTIFIER_STATE="AFTER_DOCTYPE_SYSTEM_IDENTIFIER_STATE",BOGUS_DOCTYPE_STATE="BOGUS_DOCTYPE_STATE",CDATA_SECTION_STATE="CDATA_SECTION_STATE",CDATA_SECTION_BRACKET_STATE="CDATA_SECTION_BRACKET_STATE",CDATA_SECTION_END_STATE="CDATA_SECTION_END_STATE",CHARACTER_REFERENCE_STATE="CHARACTER_REFERENCE_STATE",NAMED_CHARACTER_REFERENCE_STATE="NAMED_CHARACTER_REFERENCE_STATE",AMBIGUOUS_AMPERSAND_STATE="AMBIGUOS_AMPERSAND_STATE",NUMERIC_CHARACTER_REFERENCE_STATE="NUMERIC_CHARACTER_REFERENCE_STATE",HEXADEMICAL_CHARACTER_REFERENCE_START_STATE="HEXADEMICAL_CHARACTER_REFERENCE_START_STATE",DECIMAL_CHARACTER_REFERENCE_START_STATE="DECIMAL_CHARACTER_REFERENCE_START_STATE",HEXADEMICAL_CHARACTER_REFERENCE_STATE="HEXADEMICAL_CHARACTER_REFERENCE_STATE",DECIMAL_CHARACTER_REFERENCE_STATE="DECIMAL_CHARACTER_REFERENCE_STATE",NUMERIC_CHARACTER_REFERENCE_END_STATE="NUMERIC_CHARACTER_REFERENCE_END_STATE";function isWhitespace(T){return T===$.SPACE||T===$.LINE_FEED||T===$.TABULATION||T===$.FORM_FEED}function isAsciiDigit(T){return T>=$.DIGIT_0&&T<=$.DIGIT_9}function isAsciiUpper(T){return T>=$.LATIN_CAPITAL_A&&T<=$.LATIN_CAPITAL_Z}function isAsciiLower(T){return T>=$.LATIN_SMALL_A&&T<=$.LATIN_SMALL_Z}function isAsciiLetter(T){return isAsciiLower(T)||isAsciiUpper(T)}function isAsciiAlphaNumeric(T){return isAsciiLetter(T)||isAsciiDigit(T)}function isAsciiUpperHexDigit(T){return T>=$.LATIN_CAPITAL_A&&T<=$.LATIN_CAPITAL_F}function isAsciiLowerHexDigit(T){return T>=$.LATIN_SMALL_A&&T<=$.LATIN_SMALL_F}function isAsciiHexDigit(T){return isAsciiDigit(T)||isAsciiUpperHexDigit(T)||isAsciiLowerHexDigit(T)}function toAsciiLowerCodePoint(T){return T+32}function toChar(T){return T<=65535?String.fromCharCode(T):(T-=65536,String.fromCharCode(T>>>10&1023|55296)+String.fromCharCode(56320|1023&T))}function toAsciiLowerChar(T){return String.fromCharCode(toAsciiLowerCodePoint(T))}function findNamedEntityTreeBranch(T,e){const t=neTree[++T];let E=++T,_=E+t-1;for(;E<=_;){const T=E+_>>>1,A=neTree[T];if(A<e)E=T+1;else{if(!(A>e))return neTree[T+t];_=T-1}}return-1}class Tokenizer{constructor(){this.preprocessor=new Preprocessor,this.tokenQueue=[],this.allowCDATA=!1,this.state=DATA_STATE,this.returnState="",this.charRefCode=-1,this.tempBuff=[],this.lastStartTagName="",this.consumedAfterSnapshot=-1,this.active=!1,this.currentCharacterToken=null,this.currentToken=null,this.currentAttr=null}_err(){}_errOnNextCodePoint(T){this._consume(),this._err(T),this._unconsume()}getNextToken(){for(;!this.tokenQueue.length&&this.active;){this.consumedAfterSnapshot=0;const T=this._consume();this._ensureHibernation()||this[this.state](T)}return this.tokenQueue.shift()}write(T,e){this.active=!0,this.preprocessor.write(T,e)}insertHtmlAtCurrentPos(T){this.active=!0,this.preprocessor.insertHtmlAtCurrentPos(T)}_ensureHibernation(){if(this.preprocessor.endOfChunkHit){for(;this.consumedAfterSnapshot>0;this.consumedAfterSnapshot--)this.preprocessor.retreat();return this.active=!1,this.tokenQueue.push({type:Tokenizer.HIBERNATION_TOKEN}),!0}return!1}_consume(){return this.consumedAfterSnapshot++,this.preprocessor.advance()}_unconsume(){this.consumedAfterSnapshot--,this.preprocessor.retreat()}_reconsumeInState(T){this.state=T,this._unconsume()}_consumeSequenceIfMatch(T,e,t){let E=0,_=!0;const A=T.length;let i=0,s=e,r=void 0;for(;i<A;i++){if(i>0&&(s=this._consume(),E++),s===$.EOF){_=!1;break}if(s!==(r=T[i])&&(t||s!==toAsciiLowerCodePoint(r))){_=!1;break}}if(!_)for(;E--;)this._unconsume();return _}_isTempBufferEqualToScriptString(){if(this.tempBuff.length!==$$.SCRIPT_STRING.length)return!1;for(let T=0;T<this.tempBuff.length;T++)if(this.tempBuff[T]!==$$.SCRIPT_STRING[T])return!1;return!0}_createStartTagToken(){this.currentToken={type:Tokenizer.START_TAG_TOKEN,tagName:"",selfClosing:!1,ackSelfClosing:!1,attrs:[]}}_createEndTagToken(){this.currentToken={type:Tokenizer.END_TAG_TOKEN,tagName:"",selfClosing:!1,attrs:[]}}_createCommentToken(){this.currentToken={type:Tokenizer.COMMENT_TOKEN,data:""}}_createDoctypeToken(T){this.currentToken={type:Tokenizer.DOCTYPE_TOKEN,name:T,forceQuirks:!1,publicId:null,systemId:null}}_createCharacterToken(T,e){this.currentCharacterToken={type:T,chars:e}}_createEOFToken(){this.currentToken={type:Tokenizer.EOF_TOKEN}}_createAttr(T){this.currentAttr={name:T,value:""}}_leaveAttrName(T){null===Tokenizer.getTokenAttr(this.currentToken,this.currentAttr.name)?this.currentToken.attrs.push(this.currentAttr):this._err(ERR.duplicateAttribute),this.state=T}_leaveAttrValue(T){this.state=T}_emitCurrentToken(){this._emitCurrentCharacterToken();const T=this.currentToken;this.currentToken=null,T.type===Tokenizer.START_TAG_TOKEN?this.lastStartTagName=T.tagName:T.type===Tokenizer.END_TAG_TOKEN&&(T.attrs.length>0&&this._err(ERR.endTagWithAttributes),T.selfClosing&&this._err(ERR.endTagWithTrailingSolidus)),this.tokenQueue.push(T)}_emitCurrentCharacterToken(){this.currentCharacterToken&&(this.tokenQueue.push(this.currentCharacterToken),this.currentCharacterToken=null)}_emitEOFToken(){this._createEOFToken(),this._emitCurrentToken()}_appendCharToCurrentCharacterToken(T,e){this.currentCharacterToken&&this.currentCharacterToken.type!==T&&this._emitCurrentCharacterToken(),this.currentCharacterToken?this.currentCharacterToken.chars+=e:this._createCharacterToken(T,e)}_emitCodePoint(T){let e=Tokenizer.CHARACTER_TOKEN;isWhitespace(T)?e=Tokenizer.WHITESPACE_CHARACTER_TOKEN:T===$.NULL&&(e=Tokenizer.NULL_CHARACTER_TOKEN),this._appendCharToCurrentCharacterToken(e,toChar(T))}_emitSeveralCodePoints(T){for(let e=0;e<T.length;e++)this._emitCodePoint(T[e])}_emitChars(T){this._appendCharToCurrentCharacterToken(Tokenizer.CHARACTER_TOKEN,T)}_matchNamedCharacterReference(T){let e=null,t=1,E=findNamedEntityTreeBranch(0,T);for(this.tempBuff.push(T);E>-1;){const T=neTree[E],_=T<MAX_BRANCH_MARKER_VALUE;_&&T&HAS_DATA_FLAG&&(e=T&DATA_DUPLET_FLAG?[neTree[++E],neTree[++E]]:[neTree[++E]],t=0);const A=this._consume();if(this.tempBuff.push(A),t++,A===$.EOF)break;E=_?T&HAS_BRANCHES_FLAG?findNamedEntityTreeBranch(E,A):-1:A===T?++E:-1}for(;t--;)this.tempBuff.pop(),this._unconsume();return e}_isCharacterReferenceInAttribute(){return this.returnState===ATTRIBUTE_VALUE_DOUBLE_QUOTED_STATE||this.returnState===ATTRIBUTE_VALUE_SINGLE_QUOTED_STATE||this.returnState===ATTRIBUTE_VALUE_UNQUOTED_STATE}_isCharacterReferenceAttributeQuirk(T){if(!T&&this._isCharacterReferenceInAttribute()){const T=this._consume();return this._unconsume(),T===$.EQUALS_SIGN||isAsciiAlphaNumeric(T)}return!1}_flushCodePointsConsumedAsCharacterReference(){if(this._isCharacterReferenceInAttribute())for(let T=0;T<this.tempBuff.length;T++)this.currentAttr.value+=toChar(this.tempBuff[T]);else this._emitSeveralCodePoints(this.tempBuff);this.tempBuff=[]}[DATA_STATE](T){this.preprocessor.dropParsedChunk(),T===$.LESS_THAN_SIGN?this.state=TAG_OPEN_STATE:T===$.AMPERSAND?(this.returnState=DATA_STATE,this.state=CHARACTER_REFERENCE_STATE):T===$.NULL?(this._err(ERR.unexpectedNullCharacter),this._emitCodePoint(T)):T===$.EOF?this._emitEOFToken():this._emitCodePoint(T)}[RCDATA_STATE](T){this.preprocessor.dropParsedChunk(),T===$.AMPERSAND?(this.returnState=RCDATA_STATE,this.state=CHARACTER_REFERENCE_STATE):T===$.LESS_THAN_SIGN?this.state=RCDATA_LESS_THAN_SIGN_STATE:T===$.NULL?(this._err(ERR.unexpectedNullCharacter),this._emitChars(unicode.REPLACEMENT_CHARACTER)):T===$.EOF?this._emitEOFToken():this._emitCodePoint(T)}[RAWTEXT_STATE](T){this.preprocessor.dropParsedChunk(),T===$.LESS_THAN_SIGN?this.state=RAWTEXT_LESS_THAN_SIGN_STATE:T===$.NULL?(this._err(ERR.unexpectedNullCharacter),this._emitChars(unicode.REPLACEMENT_CHARACTER)):T===$.EOF?this._emitEOFToken():this._emitCodePoint(T)}[SCRIPT_DATA_STATE](T){this.preprocessor.dropParsedChunk(),T===$.LESS_THAN_SIGN?this.state=SCRIPT_DATA_LESS_THAN_SIGN_STATE:T===$.NULL?(this._err(ERR.unexpectedNullCharacter),this._emitChars(unicode.REPLACEMENT_CHARACTER)):T===$.EOF?this._emitEOFToken():this._emitCodePoint(T)}[PLAINTEXT_STATE](T){this.preprocessor.dropParsedChunk(),T===$.NULL?(this._err(ERR.unexpectedNullCharacter),this._emitChars(unicode.REPLACEMENT_CHARACTER)):T===$.EOF?this._emitEOFToken():this._emitCodePoint(T)}[TAG_OPEN_STATE](T){T===$.EXCLAMATION_MARK?this.state=MARKUP_DECLARATION_OPEN_STATE:T===$.SOLIDUS?this.state=END_TAG_OPEN_STATE:isAsciiLetter(T)?(this._createStartTagToken(),this._reconsumeInState(TAG_NAME_STATE)):T===$.QUESTION_MARK?(this._err(ERR.unexpectedQuestionMarkInsteadOfTagName),this._createCommentToken(),this._reconsumeInState(BOGUS_COMMENT_STATE)):T===$.EOF?(this._err(ERR.eofBeforeTagName),this._emitChars("<"),this._emitEOFToken()):(this._err(ERR.invalidFirstCharacterOfTagName),this._emitChars("<"),this._reconsumeInState(DATA_STATE))}[END_TAG_OPEN_STATE](T){isAsciiLetter(T)?(this._createEndTagToken(),this._reconsumeInState(TAG_NAME_STATE)):T===$.GREATER_THAN_SIGN?(this._err(ERR.missingEndTagName),this.state=DATA_STATE):T===$.EOF?(this._err(ERR.eofBeforeTagName),this._emitChars("</"),this._emitEOFToken()):(this._err(ERR.invalidFirstCharacterOfTagName),this._createCommentToken(),this._reconsumeInState(BOGUS_COMMENT_STATE))}[TAG_NAME_STATE](T){isWhitespace(T)?this.state=BEFORE_ATTRIBUTE_NAME_STATE:T===$.SOLIDUS?this.state=SELF_CLOSING_START_TAG_STATE:T===$.GREATER_THAN_SIGN?(this.state=DATA_STATE,this._emitCurrentToken()):isAsciiUpper(T)?this.currentToken.tagName+=toAsciiLowerChar(T):T===$.NULL?(this._err(ERR.unexpectedNullCharacter),this.currentToken.tagName+=unicode.REPLACEMENT_CHARACTER):T===$.EOF?(this._err(ERR.eofInTag),this._emitEOFToken()):this.currentToken.tagName+=toChar(T)}[RCDATA_LESS_THAN_SIGN_STATE](T){T===$.SOLIDUS?(this.tempBuff=[],this.state=RCDATA_END_TAG_OPEN_STATE):(this._emitChars("<"),this._reconsumeInState(RCDATA_STATE))}[RCDATA_END_TAG_OPEN_STATE](T){isAsciiLetter(T)?(this._createEndTagToken(),this._reconsumeInState(RCDATA_END_TAG_NAME_STATE)):(this._emitChars("</"),this._reconsumeInState(RCDATA_STATE))}[RCDATA_END_TAG_NAME_STATE](T){if(isAsciiUpper(T))this.currentToken.tagName+=toAsciiLowerChar(T),this.tempBuff.push(T);else if(isAsciiLower(T))this.currentToken.tagName+=toChar(T),this.tempBuff.push(T);else{if(this.lastStartTagName===this.currentToken.tagName){if(isWhitespace(T))return void(this.state=BEFORE_ATTRIBUTE_NAME_STATE);if(T===$.SOLIDUS)return void(this.state=SELF_CLOSING_START_TAG_STATE);if(T===$.GREATER_THAN_SIGN)return this.state=DATA_STATE,void this._emitCurrentToken()}this._emitChars("</"),this._emitSeveralCodePoints(this.tempBuff),this._reconsumeInState(RCDATA_STATE)}}[RAWTEXT_LESS_THAN_SIGN_STATE](T){T===$.SOLIDUS?(this.tempBuff=[],this.state=RAWTEXT_END_TAG_OPEN_STATE):(this._emitChars("<"),this._reconsumeInState(RAWTEXT_STATE))}[RAWTEXT_END_TAG_OPEN_STATE](T){isAsciiLetter(T)?(this._createEndTagToken(),this._reconsumeInState(RAWTEXT_END_TAG_NAME_STATE)):(this._emitChars("</"),this._reconsumeInState(RAWTEXT_STATE))}[RAWTEXT_END_TAG_NAME_STATE](T){if(isAsciiUpper(T))this.currentToken.tagName+=toAsciiLowerChar(T),this.tempBuff.push(T);else if(isAsciiLower(T))this.currentToken.tagName+=toChar(T),this.tempBuff.push(T);else{if(this.lastStartTagName===this.currentToken.tagName){if(isWhitespace(T))return void(this.state=BEFORE_ATTRIBUTE_NAME_STATE);if(T===$.SOLIDUS)return void(this.state=SELF_CLOSING_START_TAG_STATE);if(T===$.GREATER_THAN_SIGN)return this._emitCurrentToken(),void(this.state=DATA_STATE)}this._emitChars("</"),this._emitSeveralCodePoints(this.tempBuff),this._reconsumeInState(RAWTEXT_STATE)}}[SCRIPT_DATA_LESS_THAN_SIGN_STATE](T){T===$.SOLIDUS?(this.tempBuff=[],this.state=SCRIPT_DATA_END_TAG_OPEN_STATE):T===$.EXCLAMATION_MARK?(this.state=SCRIPT_DATA_ESCAPE_START_STATE,this._emitChars("<!")):(this._emitChars("<"),this._reconsumeInState(SCRIPT_DATA_STATE))}[SCRIPT_DATA_END_TAG_OPEN_STATE](T){isAsciiLetter(T)?(this._createEndTagToken(),this._reconsumeInState(SCRIPT_DATA_END_TAG_NAME_STATE)):(this._emitChars("</"),this._reconsumeInState(SCRIPT_DATA_STATE))}[SCRIPT_DATA_END_TAG_NAME_STATE](T){if(isAsciiUpper(T))this.currentToken.tagName+=toAsciiLowerChar(T),this.tempBuff.push(T);else if(isAsciiLower(T))this.currentToken.tagName+=toChar(T),this.tempBuff.push(T);else{if(this.lastStartTagName===this.currentToken.tagName){if(isWhitespace(T))return void(this.state=BEFORE_ATTRIBUTE_NAME_STATE);if(T===$.SOLIDUS)return void(this.state=SELF_CLOSING_START_TAG_STATE);if(T===$.GREATER_THAN_SIGN)return this._emitCurrentToken(),void(this.state=DATA_STATE)}this._emitChars("</"),this._emitSeveralCodePoints(this.tempBuff),this._reconsumeInState(SCRIPT_DATA_STATE)}}[SCRIPT_DATA_ESCAPE_START_STATE](T){T===$.HYPHEN_MINUS?(this.state=SCRIPT_DATA_ESCAPE_START_DASH_STATE,this._emitChars("-")):this._reconsumeInState(SCRIPT_DATA_STATE)}[SCRIPT_DATA_ESCAPE_START_DASH_STATE](T){T===$.HYPHEN_MINUS?(this.state=SCRIPT_DATA_ESCAPED_DASH_DASH_STATE,this._emitChars("-")):this._reconsumeInState(SCRIPT_DATA_STATE)}[SCRIPT_DATA_ESCAPED_STATE](T){T===$.HYPHEN_MINUS?(this.state=SCRIPT_DATA_ESCAPED_DASH_STATE,this._emitChars("-")):T===$.LESS_THAN_SIGN?this.state=SCRIPT_DATA_ESCAPED_LESS_THAN_SIGN_STATE:T===$.NULL?(this._err(ERR.unexpectedNullCharacter),this._emitChars(unicode.REPLACEMENT_CHARACTER)):T===$.EOF?(this._err(ERR.eofInScriptHtmlCommentLikeText),this._emitEOFToken()):this._emitCodePoint(T)}[SCRIPT_DATA_ESCAPED_DASH_STATE](T){T===$.HYPHEN_MINUS?(this.state=SCRIPT_DATA_ESCAPED_DASH_DASH_STATE,this._emitChars("-")):T===$.LESS_THAN_SIGN?this.state=SCRIPT_DATA_ESCAPED_LESS_THAN_SIGN_STATE:T===$.NULL?(this._err(ERR.unexpectedNullCharacter),this.state=SCRIPT_DATA_ESCAPED_STATE,this._emitChars(unicode.REPLACEMENT_CHARACTER)):T===$.EOF?(this._err(ERR.eofInScriptHtmlCommentLikeText),this._emitEOFToken()):(this.state=SCRIPT_DATA_ESCAPED_STATE,this._emitCodePoint(T))}[SCRIPT_DATA_ESCAPED_DASH_DASH_STATE](T){T===$.HYPHEN_MINUS?this._emitChars("-"):T===$.LESS_THAN_SIGN?this.state=SCRIPT_DATA_ESCAPED_LESS_THAN_SIGN_STATE:T===$.GREATER_THAN_SIGN?(this.state=SCRIPT_DATA_STATE,this._emitChars(">")):T===$.NULL?(this._err(ERR.unexpectedNullCharacter),this.state=SCRIPT_DATA_ESCAPED_STATE,this._emitChars(unicode.REPLACEMENT_CHARACTER)):T===$.EOF?(this._err(ERR.eofInScriptHtmlCommentLikeText),this._emitEOFToken()):(this.state=SCRIPT_DATA_ESCAPED_STATE,this._emitCodePoint(T))}[SCRIPT_DATA_ESCAPED_LESS_THAN_SIGN_STATE](T){T===$.SOLIDUS?(this.tempBuff=[],this.state=SCRIPT_DATA_ESCAPED_END_TAG_OPEN_STATE):isAsciiLetter(T)?(this.tempBuff=[],this._emitChars("<"),this._reconsumeInState(SCRIPT_DATA_DOUBLE_ESCAPE_START_STATE)):(this._emitChars("<"),this._reconsumeInState(SCRIPT_DATA_ESCAPED_STATE))}[SCRIPT_DATA_ESCAPED_END_TAG_OPEN_STATE](T){isAsciiLetter(T)?(this._createEndTagToken(),this._reconsumeInState(SCRIPT_DATA_ESCAPED_END_TAG_NAME_STATE)):(this._emitChars("</"),this._reconsumeInState(SCRIPT_DATA_ESCAPED_STATE))}[SCRIPT_DATA_ESCAPED_END_TAG_NAME_STATE](T){if(isAsciiUpper(T))this.currentToken.tagName+=toAsciiLowerChar(T),this.tempBuff.push(T);else if(isAsciiLower(T))this.currentToken.tagName+=toChar(T),this.tempBuff.push(T);else{if(this.lastStartTagName===this.currentToken.tagName){if(isWhitespace(T))return void(this.state=BEFORE_ATTRIBUTE_NAME_STATE);if(T===$.SOLIDUS)return void(this.state=SELF_CLOSING_START_TAG_STATE);if(T===$.GREATER_THAN_SIGN)return this._emitCurrentToken(),void(this.state=DATA_STATE)}this._emitChars("</"),this._emitSeveralCodePoints(this.tempBuff),this._reconsumeInState(SCRIPT_DATA_ESCAPED_STATE)}}[SCRIPT_DATA_DOUBLE_ESCAPE_START_STATE](T){isWhitespace(T)||T===$.SOLIDUS||T===$.GREATER_THAN_SIGN?(this.state=this._isTempBufferEqualToScriptString()?SCRIPT_DATA_DOUBLE_ESCAPED_STATE:SCRIPT_DATA_ESCAPED_STATE,this._emitCodePoint(T)):isAsciiUpper(T)?(this.tempBuff.push(toAsciiLowerCodePoint(T)),this._emitCodePoint(T)):isAsciiLower(T)?(this.tempBuff.push(T),this._emitCodePoint(T)):this._reconsumeInState(SCRIPT_DATA_ESCAPED_STATE)}[SCRIPT_DATA_DOUBLE_ESCAPED_STATE](T){T===$.HYPHEN_MINUS?(this.state=SCRIPT_DATA_DOUBLE_ESCAPED_DASH_STATE,this._emitChars("-")):T===$.LESS_THAN_SIGN?(this.state=SCRIPT_DATA_DOUBLE_ESCAPED_LESS_THAN_SIGN_STATE,this._emitChars("<")):T===$.NULL?(this._err(ERR.unexpectedNullCharacter),this._emitChars(unicode.REPLACEMENT_CHARACTER)):T===$.EOF?(this._err(ERR.eofInScriptHtmlCommentLikeText),this._emitEOFToken()):this._emitCodePoint(T)}[SCRIPT_DATA_DOUBLE_ESCAPED_DASH_STATE](T){T===$.HYPHEN_MINUS?(this.state=SCRIPT_DATA_DOUBLE_ESCAPED_DASH_DASH_STATE,this._emitChars("-")):T===$.LESS_THAN_SIGN?(this.state=SCRIPT_DATA_DOUBLE_ESCAPED_LESS_THAN_SIGN_STATE,this._emitChars("<")):T===$.NULL?(this._err(ERR.unexpectedNullCharacter),this.state=SCRIPT_DATA_DOUBLE_ESCAPED_STATE,this._emitChars(unicode.REPLACEMENT_CHARACTER)):T===$.EOF?(this._err(ERR.eofInScriptHtmlCommentLikeText),this._emitEOFToken()):(this.state=SCRIPT_DATA_DOUBLE_ESCAPED_STATE,this._emitCodePoint(T))}[SCRIPT_DATA_DOUBLE_ESCAPED_DASH_DASH_STATE](T){T===$.HYPHEN_MINUS?this._emitChars("-"):T===$.LESS_THAN_SIGN?(this.state=SCRIPT_DATA_DOUBLE_ESCAPED_LESS_THAN_SIGN_STATE,this._emitChars("<")):T===$.GREATER_THAN_SIGN?(this.state=SCRIPT_DATA_STATE,this._emitChars(">")):T===$.NULL?(this._err(ERR.unexpectedNullCharacter),this.state=SCRIPT_DATA_DOUBLE_ESCAPED_STATE,this._emitChars(unicode.REPLACEMENT_CHARACTER)):T===$.EOF?(this._err(ERR.eofInScriptHtmlCommentLikeText),this._emitEOFToken()):(this.state=SCRIPT_DATA_DOUBLE_ESCAPED_STATE,this._emitCodePoint(T))}[SCRIPT_DATA_DOUBLE_ESCAPED_LESS_THAN_SIGN_STATE](T){T===$.SOLIDUS?(this.tempBuff=[],this.state=SCRIPT_DATA_DOUBLE_ESCAPE_END_STATE,this._emitChars("/")):this._reconsumeInState(SCRIPT_DATA_DOUBLE_ESCAPED_STATE)}[SCRIPT_DATA_DOUBLE_ESCAPE_END_STATE](T){isWhitespace(T)||T===$.SOLIDUS||T===$.GREATER_THAN_SIGN?(this.state=this._isTempBufferEqualToScriptString()?SCRIPT_DATA_ESCAPED_STATE:SCRIPT_DATA_DOUBLE_ESCAPED_STATE,this._emitCodePoint(T)):isAsciiUpper(T)?(this.tempBuff.push(toAsciiLowerCodePoint(T)),this._emitCodePoint(T)):isAsciiLower(T)?(this.tempBuff.push(T),this._emitCodePoint(T)):this._reconsumeInState(SCRIPT_DATA_DOUBLE_ESCAPED_STATE)}[BEFORE_ATTRIBUTE_NAME_STATE](T){isWhitespace(T)||(T===$.SOLIDUS||T===$.GREATER_THAN_SIGN||T===$.EOF?this._reconsumeInState(AFTER_ATTRIBUTE_NAME_STATE):T===$.EQUALS_SIGN?(this._err(ERR.unexpectedEqualsSignBeforeAttributeName),this._createAttr("="),this.state=ATTRIBUTE_NAME_STATE):(this._createAttr(""),this._reconsumeInState(ATTRIBUTE_NAME_STATE)))}[ATTRIBUTE_NAME_STATE](T){isWhitespace(T)||T===$.SOLIDUS||T===$.GREATER_THAN_SIGN||T===$.EOF?(this._leaveAttrName(AFTER_ATTRIBUTE_NAME_STATE),this._unconsume()):T===$.EQUALS_SIGN?this._leaveAttrName(BEFORE_ATTRIBUTE_VALUE_STATE):isAsciiUpper(T)?this.currentAttr.name+=toAsciiLowerChar(T):T===$.QUOTATION_MARK||T===$.APOSTROPHE||T===$.LESS_THAN_SIGN?(this._err(ERR.unexpectedCharacterInAttributeName),this.currentAttr.name+=toChar(T)):T===$.NULL?(this._err(ERR.unexpectedNullCharacter),this.currentAttr.name+=unicode.REPLACEMENT_CHARACTER):this.currentAttr.name+=toChar(T)}[AFTER_ATTRIBUTE_NAME_STATE](T){isWhitespace(T)||(T===$.SOLIDUS?this.state=SELF_CLOSING_START_TAG_STATE:T===$.EQUALS_SIGN?this.state=BEFORE_ATTRIBUTE_VALUE_STATE:T===$.GREATER_THAN_SIGN?(this.state=DATA_STATE,this._emitCurrentToken()):T===$.EOF?(this._err(ERR.eofInTag),this._emitEOFToken()):(this._createAttr(""),this._reconsumeInState(ATTRIBUTE_NAME_STATE)))}[BEFORE_ATTRIBUTE_VALUE_STATE](T){isWhitespace(T)||(T===$.QUOTATION_MARK?this.state=ATTRIBUTE_VALUE_DOUBLE_QUOTED_STATE:T===$.APOSTROPHE?this.state=ATTRIBUTE_VALUE_SINGLE_QUOTED_STATE:T===$.GREATER_THAN_SIGN?(this._err(ERR.missingAttributeValue),this.state=DATA_STATE,this._emitCurrentToken()):this._reconsumeInState(ATTRIBUTE_VALUE_UNQUOTED_STATE))}[ATTRIBUTE_VALUE_DOUBLE_QUOTED_STATE](T){T===$.QUOTATION_MARK?this.state=AFTER_ATTRIBUTE_VALUE_QUOTED_STATE:T===$.AMPERSAND?(this.returnState=ATTRIBUTE_VALUE_DOUBLE_QUOTED_STATE,this.state=CHARACTER_REFERENCE_STATE):T===$.NULL?(this._err(ERR.unexpectedNullCharacter),this.currentAttr.value+=unicode.REPLACEMENT_CHARACTER):T===$.EOF?(this._err(ERR.eofInTag),this._emitEOFToken()):this.currentAttr.value+=toChar(T)}[ATTRIBUTE_VALUE_SINGLE_QUOTED_STATE](T){T===$.APOSTROPHE?this.state=AFTER_ATTRIBUTE_VALUE_QUOTED_STATE:T===$.AMPERSAND?(this.returnState=ATTRIBUTE_VALUE_SINGLE_QUOTED_STATE,this.state=CHARACTER_REFERENCE_STATE):T===$.NULL?(this._err(ERR.unexpectedNullCharacter),this.currentAttr.value+=unicode.REPLACEMENT_CHARACTER):T===$.EOF?(this._err(ERR.eofInTag),this._emitEOFToken()):this.currentAttr.value+=toChar(T)}[ATTRIBUTE_VALUE_UNQUOTED_STATE](T){isWhitespace(T)?this._leaveAttrValue(BEFORE_ATTRIBUTE_NAME_STATE):T===$.AMPERSAND?(this.returnState=ATTRIBUTE_VALUE_UNQUOTED_STATE,this.state=CHARACTER_REFERENCE_STATE):T===$.GREATER_THAN_SIGN?(this._leaveAttrValue(DATA_STATE),this._emitCurrentToken()):T===$.NULL?(this._err(ERR.unexpectedNullCharacter),this.currentAttr.value+=unicode.REPLACEMENT_CHARACTER):T===$.QUOTATION_MARK||T===$.APOSTROPHE||T===$.LESS_THAN_SIGN||T===$.EQUALS_SIGN||T===$.GRAVE_ACCENT?(this._err(ERR.unexpectedCharacterInUnquotedAttributeValue),this.currentAttr.value+=toChar(T)):T===$.EOF?(this._err(ERR.eofInTag),this._emitEOFToken()):this.currentAttr.value+=toChar(T)}[AFTER_ATTRIBUTE_VALUE_QUOTED_STATE](T){isWhitespace(T)?this._leaveAttrValue(BEFORE_ATTRIBUTE_NAME_STATE):T===$.SOLIDUS?this._leaveAttrValue(SELF_CLOSING_START_TAG_STATE):T===$.GREATER_THAN_SIGN?(this._leaveAttrValue(DATA_STATE),this._emitCurrentToken()):T===$.EOF?(this._err(ERR.eofInTag),this._emitEOFToken()):(this._err(ERR.missingWhitespaceBetweenAttributes),this._reconsumeInState(BEFORE_ATTRIBUTE_NAME_STATE))}[SELF_CLOSING_START_TAG_STATE](T){T===$.GREATER_THAN_SIGN?(this.currentToken.selfClosing=!0,this.state=DATA_STATE,this._emitCurrentToken()):T===$.EOF?(this._err(ERR.eofInTag),this._emitEOFToken()):(this._err(ERR.unexpectedSolidusInTag),this._reconsumeInState(BEFORE_ATTRIBUTE_NAME_STATE))}[BOGUS_COMMENT_STATE](T){T===$.GREATER_THAN_SIGN?(this.state=DATA_STATE,this._emitCurrentToken()):T===$.EOF?(this._emitCurrentToken(),this._emitEOFToken()):T===$.NULL?(this._err(ERR.unexpectedNullCharacter),this.currentToken.data+=unicode.REPLACEMENT_CHARACTER):this.currentToken.data+=toChar(T)}[MARKUP_DECLARATION_OPEN_STATE](T){this._consumeSequenceIfMatch($$.DASH_DASH_STRING,T,!0)?(this._createCommentToken(),this.state=COMMENT_START_STATE):this._consumeSequenceIfMatch($$.DOCTYPE_STRING,T,!1)?this.state=DOCTYPE_STATE:this._consumeSequenceIfMatch($$.CDATA_START_STRING,T,!0)?this.allowCDATA?this.state=CDATA_SECTION_STATE:(this._err(ERR.cdataInHtmlContent),this._createCommentToken(),this.currentToken.data="[CDATA[",this.state=BOGUS_COMMENT_STATE):this._ensureHibernation()||(this._err(ERR.incorrectlyOpenedComment),this._createCommentToken(),this._reconsumeInState(BOGUS_COMMENT_STATE))}[COMMENT_START_STATE](T){T===$.HYPHEN_MINUS?this.state=COMMENT_START_DASH_STATE:T===$.GREATER_THAN_SIGN?(this._err(ERR.abruptClosingOfEmptyComment),this.state=DATA_STATE,this._emitCurrentToken()):this._reconsumeInState(COMMENT_STATE)}[COMMENT_START_DASH_STATE](T){T===$.HYPHEN_MINUS?this.state=COMMENT_END_STATE:T===$.GREATER_THAN_SIGN?(this._err(ERR.abruptClosingOfEmptyComment),this.state=DATA_STATE,this._emitCurrentToken()):T===$.EOF?(this._err(ERR.eofInComment),this._emitCurrentToken(),this._emitEOFToken()):(this.currentToken.data+="-",this._reconsumeInState(COMMENT_STATE))}[COMMENT_STATE](T){T===$.HYPHEN_MINUS?this.state=COMMENT_END_DASH_STATE:T===$.LESS_THAN_SIGN?(this.currentToken.data+="<",this.state=COMMENT_LESS_THAN_SIGN_STATE):T===$.NULL?(this._err(ERR.unexpectedNullCharacter),this.currentToken.data+=unicode.REPLACEMENT_CHARACTER):T===$.EOF?(this._err(ERR.eofInComment),this._emitCurrentToken(),this._emitEOFToken()):this.currentToken.data+=toChar(T)}[COMMENT_LESS_THAN_SIGN_STATE](T){T===$.EXCLAMATION_MARK?(this.currentToken.data+="!",this.state=COMMENT_LESS_THAN_SIGN_BANG_STATE):T===$.LESS_THAN_SIGN?this.currentToken.data+="!":this._reconsumeInState(COMMENT_STATE)}[COMMENT_LESS_THAN_SIGN_BANG_STATE](T){T===$.HYPHEN_MINUS?this.state=COMMENT_LESS_THAN_SIGN_BANG_DASH_STATE:this._reconsumeInState(COMMENT_STATE)}[COMMENT_LESS_THAN_SIGN_BANG_DASH_STATE](T){T===$.HYPHEN_MINUS?this.state=COMMENT_LESS_THAN_SIGN_BANG_DASH_DASH_STATE:this._reconsumeInState(COMMENT_END_DASH_STATE)}[COMMENT_LESS_THAN_SIGN_BANG_DASH_DASH_STATE](T){T!==$.GREATER_THAN_SIGN&&T!==$.EOF&&this._err(ERR.nestedComment),this._reconsumeInState(COMMENT_END_STATE)}[COMMENT_END_DASH_STATE](T){T===$.HYPHEN_MINUS?this.state=COMMENT_END_STATE:T===$.EOF?(this._err(ERR.eofInComment),this._emitCurrentToken(),this._emitEOFToken()):(this.currentToken.data+="-",this._reconsumeInState(COMMENT_STATE))}[COMMENT_END_STATE](T){T===$.GREATER_THAN_SIGN?(this.state=DATA_STATE,this._emitCurrentToken()):T===$.EXCLAMATION_MARK?this.state=COMMENT_END_BANG_STATE:T===$.HYPHEN_MINUS?this.currentToken.data+="-":T===$.EOF?(this._err(ERR.eofInComment),this._emitCurrentToken(),this._emitEOFToken()):(this.currentToken.data+="--",this._reconsumeInState(COMMENT_STATE))}[COMMENT_END_BANG_STATE](T){T===$.HYPHEN_MINUS?(this.currentToken.data+="--!",this.state=COMMENT_END_DASH_STATE):T===$.GREATER_THAN_SIGN?(this._err(ERR.incorrectlyClosedComment),this.state=DATA_STATE,this._emitCurrentToken()):T===$.EOF?(this._err(ERR.eofInComment),this._emitCurrentToken(),this._emitEOFToken()):(this.currentToken.data+="--!",this._reconsumeInState(COMMENT_STATE))}[DOCTYPE_STATE](T){isWhitespace(T)?this.state=BEFORE_DOCTYPE_NAME_STATE:T===$.GREATER_THAN_SIGN?this._reconsumeInState(BEFORE_DOCTYPE_NAME_STATE):T===$.EOF?(this._err(ERR.eofInDoctype),this._createDoctypeToken(null),this.currentToken.forceQuirks=!0,this._emitCurrentToken(),this._emitEOFToken()):(this._err(ERR.missingWhitespaceBeforeDoctypeName),this._reconsumeInState(BEFORE_DOCTYPE_NAME_STATE))}[BEFORE_DOCTYPE_NAME_STATE](T){isWhitespace(T)||(isAsciiUpper(T)?(this._createDoctypeToken(toAsciiLowerChar(T)),this.state=DOCTYPE_NAME_STATE):T===$.NULL?(this._err(ERR.unexpectedNullCharacter),this._createDoctypeToken(unicode.REPLACEMENT_CHARACTER),this.state=DOCTYPE_NAME_STATE):T===$.GREATER_THAN_SIGN?(this._err(ERR.missingDoctypeName),this._createDoctypeToken(null),this.currentToken.forceQuirks=!0,this._emitCurrentToken(),this.state=DATA_STATE):T===$.EOF?(this._err(ERR.eofInDoctype),this._createDoctypeToken(null),this.currentToken.forceQuirks=!0,this._emitCurrentToken(),this._emitEOFToken()):(this._createDoctypeToken(toChar(T)),this.state=DOCTYPE_NAME_STATE))}[DOCTYPE_NAME_STATE](T){isWhitespace(T)?this.state=AFTER_DOCTYPE_NAME_STATE:T===$.GREATER_THAN_SIGN?(this.state=DATA_STATE,this._emitCurrentToken()):isAsciiUpper(T)?this.currentToken.name+=toAsciiLowerChar(T):T===$.NULL?(this._err(ERR.unexpectedNullCharacter),this.currentToken.name+=unicode.REPLACEMENT_CHARACTER):T===$.EOF?(this._err(ERR.eofInDoctype),this.currentToken.forceQuirks=!0,this._emitCurrentToken(),this._emitEOFToken()):this.currentToken.name+=toChar(T)}[AFTER_DOCTYPE_NAME_STATE](T){isWhitespace(T)||(T===$.GREATER_THAN_SIGN?(this.state=DATA_STATE,this._emitCurrentToken()):T===$.EOF?(this._err(ERR.eofInDoctype),this.currentToken.forceQuirks=!0,this._emitCurrentToken(),this._emitEOFToken()):this._consumeSequenceIfMatch($$.PUBLIC_STRING,T,!1)?this.state=AFTER_DOCTYPE_PUBLIC_KEYWORD_STATE:this._consumeSequenceIfMatch($$.SYSTEM_STRING,T,!1)?this.state=AFTER_DOCTYPE_SYSTEM_KEYWORD_STATE:this._ensureHibernation()||(this._err(ERR.invalidCharacterSequenceAfterDoctypeName),this.currentToken.forceQuirks=!0,this._reconsumeInState(BOGUS_DOCTYPE_STATE)))}[AFTER_DOCTYPE_PUBLIC_KEYWORD_STATE](T){isWhitespace(T)?this.state=BEFORE_DOCTYPE_PUBLIC_IDENTIFIER_STATE:T===$.QUOTATION_MARK?(this._err(ERR.missingWhitespaceAfterDoctypePublicKeyword),this.currentToken.publicId="",this.state=DOCTYPE_PUBLIC_IDENTIFIER_DOUBLE_QUOTED_STATE):T===$.APOSTROPHE?(this._err(ERR.missingWhitespaceAfterDoctypePublicKeyword),this.currentToken.publicId="",this.state=DOCTYPE_PUBLIC_IDENTIFIER_SINGLE_QUOTED_STATE):T===$.GREATER_THAN_SIGN?(this._err(ERR.missingDoctypePublicIdentifier),this.currentToken.forceQuirks=!0,this.state=DATA_STATE,this._emitCurrentToken()):T===$.EOF?(this._err(ERR.eofInDoctype),this.currentToken.forceQuirks=!0,this._emitCurrentToken(),this._emitEOFToken()):(this._err(ERR.missingQuoteBeforeDoctypePublicIdentifier),this.currentToken.forceQuirks=!0,this._reconsumeInState(BOGUS_DOCTYPE_STATE))}[BEFORE_DOCTYPE_PUBLIC_IDENTIFIER_STATE](T){isWhitespace(T)||(T===$.QUOTATION_MARK?(this.currentToken.publicId="",this.state=DOCTYPE_PUBLIC_IDENTIFIER_DOUBLE_QUOTED_STATE):T===$.APOSTROPHE?(this.currentToken.publicId="",this.state=DOCTYPE_PUBLIC_IDENTIFIER_SINGLE_QUOTED_STATE):T===$.GREATER_THAN_SIGN?(this._err(ERR.missingDoctypePublicIdentifier),this.currentToken.forceQuirks=!0,this.state=DATA_STATE,this._emitCurrentToken()):T===$.EOF?(this._err(ERR.eofInDoctype),this.currentToken.forceQuirks=!0,this._emitCurrentToken(),this._emitEOFToken()):(this._err(ERR.missingQuoteBeforeDoctypePublicIdentifier),this.currentToken.forceQuirks=!0,this._reconsumeInState(BOGUS_DOCTYPE_STATE)))}[DOCTYPE_PUBLIC_IDENTIFIER_DOUBLE_QUOTED_STATE](T){T===$.QUOTATION_MARK?this.state=AFTER_DOCTYPE_PUBLIC_IDENTIFIER_STATE:T===$.NULL?(this._err(ERR.unexpectedNullCharacter),this.currentToken.publicId+=unicode.REPLACEMENT_CHARACTER):T===$.GREATER_THAN_SIGN?(this._err(ERR.abruptDoctypePublicIdentifier),this.currentToken.forceQuirks=!0,this._emitCurrentToken(),this.state=DATA_STATE):T===$.EOF?(this._err(ERR.eofInDoctype),this.currentToken.forceQuirks=!0,this._emitCurrentToken(),this._emitEOFToken()):this.currentToken.publicId+=toChar(T)}[DOCTYPE_PUBLIC_IDENTIFIER_SINGLE_QUOTED_STATE](T){T===$.APOSTROPHE?this.state=AFTER_DOCTYPE_PUBLIC_IDENTIFIER_STATE:T===$.NULL?(this._err(ERR.unexpectedNullCharacter),this.currentToken.publicId+=unicode.REPLACEMENT_CHARACTER):T===$.GREATER_THAN_SIGN?(this._err(ERR.abruptDoctypePublicIdentifier),this.currentToken.forceQuirks=!0,this._emitCurrentToken(),this.state=DATA_STATE):T===$.EOF?(this._err(ERR.eofInDoctype),this.currentToken.forceQuirks=!0,this._emitCurrentToken(),this._emitEOFToken()):this.currentToken.publicId+=toChar(T)}[AFTER_DOCTYPE_PUBLIC_IDENTIFIER_STATE](T){isWhitespace(T)?this.state=BETWEEN_DOCTYPE_PUBLIC_AND_SYSTEM_IDENTIFIERS_STATE:T===$.GREATER_THAN_SIGN?(this.state=DATA_STATE,this._emitCurrentToken()):T===$.QUOTATION_MARK?(this._err(ERR.missingWhitespaceBetweenDoctypePublicAndSystemIdentifiers),this.currentToken.systemId="",this.state=DOCTYPE_SYSTEM_IDENTIFIER_DOUBLE_QUOTED_STATE):T===$.APOSTROPHE?(this._err(ERR.missingWhitespaceBetweenDoctypePublicAndSystemIdentifiers),this.currentToken.systemId="",this.state=DOCTYPE_SYSTEM_IDENTIFIER_SINGLE_QUOTED_STATE):T===$.EOF?(this._err(ERR.eofInDoctype),this.currentToken.forceQuirks=!0,this._emitCurrentToken(),this._emitEOFToken()):(this._err(ERR.missingQuoteBeforeDoctypeSystemIdentifier),this.currentToken.forceQuirks=!0,this._reconsumeInState(BOGUS_DOCTYPE_STATE))}[BETWEEN_DOCTYPE_PUBLIC_AND_SYSTEM_IDENTIFIERS_STATE](T){isWhitespace(T)||(T===$.GREATER_THAN_SIGN?(this._emitCurrentToken(),this.state=DATA_STATE):T===$.QUOTATION_MARK?(this.currentToken.systemId="",this.state=DOCTYPE_SYSTEM_IDENTIFIER_DOUBLE_QUOTED_STATE):T===$.APOSTROPHE?(this.currentToken.systemId="",this.state=DOCTYPE_SYSTEM_IDENTIFIER_SINGLE_QUOTED_STATE):T===$.EOF?(this._err(ERR.eofInDoctype),this.currentToken.forceQuirks=!0,this._emitCurrentToken(),this._emitEOFToken()):(this._err(ERR.missingQuoteBeforeDoctypeSystemIdentifier),this.currentToken.forceQuirks=!0,this._reconsumeInState(BOGUS_DOCTYPE_STATE)))}[AFTER_DOCTYPE_SYSTEM_KEYWORD_STATE](T){isWhitespace(T)?this.state=BEFORE_DOCTYPE_SYSTEM_IDENTIFIER_STATE:T===$.QUOTATION_MARK?(this._err(ERR.missingWhitespaceAfterDoctypeSystemKeyword),this.currentToken.systemId="",this.state=DOCTYPE_SYSTEM_IDENTIFIER_DOUBLE_QUOTED_STATE):T===$.APOSTROPHE?(this._err(ERR.missingWhitespaceAfterDoctypeSystemKeyword),this.currentToken.systemId="",this.state=DOCTYPE_SYSTEM_IDENTIFIER_SINGLE_QUOTED_STATE):T===$.GREATER_THAN_SIGN?(this._err(ERR.missingDoctypeSystemIdentifier),this.currentToken.forceQuirks=!0,this.state=DATA_STATE,this._emitCurrentToken()):T===$.EOF?(this._err(ERR.eofInDoctype),this.currentToken.forceQuirks=!0,this._emitCurrentToken(),this._emitEOFToken()):(this._err(ERR.missingQuoteBeforeDoctypeSystemIdentifier),this.currentToken.forceQuirks=!0,this._reconsumeInState(BOGUS_DOCTYPE_STATE))}[BEFORE_DOCTYPE_SYSTEM_IDENTIFIER_STATE](T){isWhitespace(T)||(T===$.QUOTATION_MARK?(this.currentToken.systemId="",this.state=DOCTYPE_SYSTEM_IDENTIFIER_DOUBLE_QUOTED_STATE):T===$.APOSTROPHE?(this.currentToken.systemId="",this.state=DOCTYPE_SYSTEM_IDENTIFIER_SINGLE_QUOTED_STATE):T===$.GREATER_THAN_SIGN?(this._err(ERR.missingDoctypeSystemIdentifier),this.currentToken.forceQuirks=!0,this.state=DATA_STATE,this._emitCurrentToken()):T===$.EOF?(this._err(ERR.eofInDoctype),this.currentToken.forceQuirks=!0,this._emitCurrentToken(),this._emitEOFToken()):(this._err(ERR.missingQuoteBeforeDoctypeSystemIdentifier),this.currentToken.forceQuirks=!0,this._reconsumeInState(BOGUS_DOCTYPE_STATE)))}[DOCTYPE_SYSTEM_IDENTIFIER_DOUBLE_QUOTED_STATE](T){T===$.QUOTATION_MARK?this.state=AFTER_DOCTYPE_SYSTEM_IDENTIFIER_STATE:T===$.NULL?(this._err(ERR.unexpectedNullCharacter),this.currentToken.systemId+=unicode.REPLACEMENT_CHARACTER):T===$.GREATER_THAN_SIGN?(this._err(ERR.abruptDoctypeSystemIdentifier),this.currentToken.forceQuirks=!0,this._emitCurrentToken(),this.state=DATA_STATE):T===$.EOF?(this._err(ERR.eofInDoctype),this.currentToken.forceQuirks=!0,this._emitCurrentToken(),this._emitEOFToken()):this.currentToken.systemId+=toChar(T)}[DOCTYPE_SYSTEM_IDENTIFIER_SINGLE_QUOTED_STATE](T){T===$.APOSTROPHE?this.state=AFTER_DOCTYPE_SYSTEM_IDENTIFIER_STATE:T===$.NULL?(this._err(ERR.unexpectedNullCharacter),this.currentToken.systemId+=unicode.REPLACEMENT_CHARACTER):T===$.GREATER_THAN_SIGN?(this._err(ERR.abruptDoctypeSystemIdentifier),this.currentToken.forceQuirks=!0,this._emitCurrentToken(),this.state=DATA_STATE):T===$.EOF?(this._err(ERR.eofInDoctype),this.currentToken.forceQuirks=!0,this._emitCurrentToken(),this._emitEOFToken()):this.currentToken.systemId+=toChar(T)}[AFTER_DOCTYPE_SYSTEM_IDENTIFIER_STATE](T){isWhitespace(T)||(T===$.GREATER_THAN_SIGN?(this._emitCurrentToken(),this.state=DATA_STATE):T===$.EOF?(this._err(ERR.eofInDoctype),this.currentToken.forceQuirks=!0,this._emitCurrentToken(),this._emitEOFToken()):(this._err(ERR.unexpectedCharacterAfterDoctypeSystemIdentifier),this._reconsumeInState(BOGUS_DOCTYPE_STATE)))}[BOGUS_DOCTYPE_STATE](T){T===$.GREATER_THAN_SIGN?(this._emitCurrentToken(),this.state=DATA_STATE):T===$.NULL?this._err(ERR.unexpectedNullCharacter):T===$.EOF&&(this._emitCurrentToken(),this._emitEOFToken())}[CDATA_SECTION_STATE](T){T===$.RIGHT_SQUARE_BRACKET?this.state=CDATA_SECTION_BRACKET_STATE:T===$.EOF?(this._err(ERR.eofInCdata),this._emitEOFToken()):this._emitCodePoint(T)}[CDATA_SECTION_BRACKET_STATE](T){T===$.RIGHT_SQUARE_BRACKET?this.state=CDATA_SECTION_END_STATE:(this._emitChars("]"),this._reconsumeInState(CDATA_SECTION_STATE))}[CDATA_SECTION_END_STATE](T){T===$.GREATER_THAN_SIGN?this.state=DATA_STATE:T===$.RIGHT_SQUARE_BRACKET?this._emitChars("]"):(this._emitChars("]]"),this._reconsumeInState(CDATA_SECTION_STATE))}[CHARACTER_REFERENCE_STATE](T){this.tempBuff=[$.AMPERSAND],T===$.NUMBER_SIGN?(this.tempBuff.push(T),this.state=NUMERIC_CHARACTER_REFERENCE_STATE):isAsciiAlphaNumeric(T)?this._reconsumeInState(NAMED_CHARACTER_REFERENCE_STATE):(this._flushCodePointsConsumedAsCharacterReference(),this._reconsumeInState(this.returnState))}[NAMED_CHARACTER_REFERENCE_STATE](T){const e=this._matchNamedCharacterReference(T);if(this._ensureHibernation())this.tempBuff=[$.AMPERSAND];else if(e){const T=this.tempBuff[this.tempBuff.length-1]===$.SEMICOLON;this._isCharacterReferenceAttributeQuirk(T)||(T||this._errOnNextCodePoint(ERR.missingSemicolonAfterCharacterReference),this.tempBuff=e),this._flushCodePointsConsumedAsCharacterReference(),this.state=this.returnState}else this._flushCodePointsConsumedAsCharacterReference(),this.state=AMBIGUOUS_AMPERSAND_STATE}[AMBIGUOUS_AMPERSAND_STATE](T){isAsciiAlphaNumeric(T)?this._isCharacterReferenceInAttribute()?this.currentAttr.value+=toChar(T):this._emitCodePoint(T):(T===$.SEMICOLON&&this._err(ERR.unknownNamedCharacterReference),this._reconsumeInState(this.returnState))}[NUMERIC_CHARACTER_REFERENCE_STATE](T){this.charRefCode=0,T===$.LATIN_SMALL_X||T===$.LATIN_CAPITAL_X?(this.tempBuff.push(T),this.state=HEXADEMICAL_CHARACTER_REFERENCE_START_STATE):this._reconsumeInState(DECIMAL_CHARACTER_REFERENCE_START_STATE)}[HEXADEMICAL_CHARACTER_REFERENCE_START_STATE](T){isAsciiHexDigit(T)?this._reconsumeInState(HEXADEMICAL_CHARACTER_REFERENCE_STATE):(this._err(ERR.absenceOfDigitsInNumericCharacterReference),this._flushCodePointsConsumedAsCharacterReference(),this._reconsumeInState(this.returnState))}[DECIMAL_CHARACTER_REFERENCE_START_STATE](T){isAsciiDigit(T)?this._reconsumeInState(DECIMAL_CHARACTER_REFERENCE_STATE):(this._err(ERR.absenceOfDigitsInNumericCharacterReference),this._flushCodePointsConsumedAsCharacterReference(),this._reconsumeInState(this.returnState))}[HEXADEMICAL_CHARACTER_REFERENCE_STATE](T){isAsciiUpperHexDigit(T)?this.charRefCode=16*this.charRefCode+T-55:isAsciiLowerHexDigit(T)?this.charRefCode=16*this.charRefCode+T-87:isAsciiDigit(T)?this.charRefCode=16*this.charRefCode+T-48:T===$.SEMICOLON?this.state=NUMERIC_CHARACTER_REFERENCE_END_STATE:(this._err(ERR.missingSemicolonAfterCharacterReference),this._reconsumeInState(NUMERIC_CHARACTER_REFERENCE_END_STATE))}[DECIMAL_CHARACTER_REFERENCE_STATE](T){isAsciiDigit(T)?this.charRefCode=10*this.charRefCode+T-48:T===$.SEMICOLON?this.state=NUMERIC_CHARACTER_REFERENCE_END_STATE:(this._err(ERR.missingSemicolonAfterCharacterReference),this._reconsumeInState(NUMERIC_CHARACTER_REFERENCE_END_STATE))}[NUMERIC_CHARACTER_REFERENCE_END_STATE](){if(this.charRefCode===$.NULL)this._err(ERR.nullCharacterReference),this.charRefCode=$.REPLACEMENT_CHARACTER;else if(this.charRefCode>1114111)this._err(ERR.characterReferenceOutsideUnicodeRange),this.charRefCode=$.REPLACEMENT_CHARACTER;else if(unicode.isSurrogate(this.charRefCode))this._err(ERR.surrogateCharacterReference),this.charRefCode=$.REPLACEMENT_CHARACTER;else if(unicode.isUndefinedCodePoint(this.charRefCode))this._err(ERR.noncharacterCharacterReference);else if(unicode.isControlCodePoint(this.charRefCode)||this.charRefCode===$.CARRIAGE_RETURN){this._err(ERR.controlCharacterReference);const T=C1_CONTROLS_REFERENCE_REPLACEMENTS[this.charRefCode];T&&(this.charRefCode=T)}this.tempBuff=[this.charRefCode],this._flushCodePointsConsumedAsCharacterReference(),this._reconsumeInState(this.returnState)}}Tokenizer.CHARACTER_TOKEN="CHARACTER_TOKEN",Tokenizer.NULL_CHARACTER_TOKEN="NULL_CHARACTER_TOKEN",Tokenizer.WHITESPACE_CHARACTER_TOKEN="WHITESPACE_CHARACTER_TOKEN",Tokenizer.START_TAG_TOKEN="START_TAG_TOKEN",Tokenizer.END_TAG_TOKEN="END_TAG_TOKEN",Tokenizer.COMMENT_TOKEN="COMMENT_TOKEN",Tokenizer.DOCTYPE_TOKEN="DOCTYPE_TOKEN",Tokenizer.EOF_TOKEN="EOF_TOKEN",Tokenizer.HIBERNATION_TOKEN="HIBERNATION_TOKEN",Tokenizer.MODE={DATA:DATA_STATE,RCDATA:RCDATA_STATE,RAWTEXT:RAWTEXT_STATE,SCRIPT_DATA:SCRIPT_DATA_STATE,PLAINTEXT:PLAINTEXT_STATE},Tokenizer.getTokenAttr=function(T,e){for(let t=T.attrs.length-1;t>=0;t--)if(T.attrs[t].name===e)return T.attrs[t].value;return null},module.exports=Tokenizer;