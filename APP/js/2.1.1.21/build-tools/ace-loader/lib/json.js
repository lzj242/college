"use strict";var _util=require("./util"),path=require("path"),cardJsonPlugin=require("./cardJson-plugin"),transCardArray=require("./templater/exp").transCardArray,REG_EVENT_STRING=/("\s*\$event\..+")|('\s*\$event\..+')/g,REG_EVENT=/\$event\.[\w]+/g,REG_THIS=/this\..*/g;function parseCard(_this,source){source=source.replace(/\/\*((\n|\r|.)*?)\*\//gm,""),source=source.replace(/(\s|\;|^|\{|\})\/\/.*$/gm,"$1"),0===source.trim().indexOf("export default")&&(source=source.replace("export default",""));var extName=path.extname(_this.resourcePath);".json"!==extName&&".js"!==extName||(source=source.replace(REG_EVENT_STRING,function(e){return e.slice(1,-1)}),source=source.replace(REG_EVENT,function(e){return'"'+e+'"'}),source=source.replace(REG_THIS,function(e){return'"'!==e.charAt(e.length-1)&&"'"!==e.charAt(e.length-1)&&'",'!==e.slice(-2)&&"',"!==e.slice(-2)&&(e=","===e.charAt(e.length-1)?'"{{'.concat(transCardArray(e.slice(0,-1)),'}}",').replace(/this\./g,""):'"{{'.concat(transCardArray(e),'}}"').replace(/this\./g,"")),e})),source=JSON.stringify(eval("("+source+")"));var jsonPaths=mkJsonFiles(_this);return cardJsonPlugin.compileJson(_this._compiler,"init",jsonPaths.indexJson),".json"===extName||".js"===extName?(cardJsonPlugin.compileJson(_this._compiler,"actions",jsonPaths.indexJson,JSON.parse(source).actions,"actions"),cardJsonPlugin.compileJson(_this._compiler,"data",jsonPaths.indexJson,JSON.parse(source).data,"data")):".css"===extName||".less"===extName||".sass"===extName||".scss"===extName?cardJsonPlugin.compileJson(_this._compiler,"styles",jsonPaths.indexJson,JSON.parse(source),"styles"):".hml"===extName&&cardJsonPlugin.compileJson(_this._compiler,"template",jsonPaths.indexJson,JSON.parse(source),"template"),source}function mkJsonFiles(e){var s="",r=e._compiler.options.entry,t=e.resourcePath;return Object.keys(r).forEach(function(e){path.dirname(path.resolve(r[e]))===path.dirname(t)&&(s=e+".json")}),{indexJson:s=path.resolve(e._compiler.options.output.path,s)}}module.exports=function(e){if(this.cacheable&&this.cacheable(),"card"===process.env.DEVICE_LEVEL){try{e=parseCard(this,e)}catch(e){return(0,_util.logWarn)(this,[{reason:"ERROR: Failed to parse the file : "+this.resourcePath}]),"{}"}return"{}"}return"module.exports = ".concat(e)};