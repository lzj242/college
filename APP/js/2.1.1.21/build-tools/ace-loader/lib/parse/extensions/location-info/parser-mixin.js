"use strict";const Mixin=require("../../utils/mixin"),Tokenizer=require("../../tokenizer"),LocationInfoTokenizerMixin=require("./tokenizer-mixin"),LocationInfoOpenElementStackMixin=require("./open-element-stack-mixin"),HTML=require("../../common/html"),$=HTML.TAG_NAMES;class LocationInfoParserMixin extends Mixin{constructor(e){super(e),this.parser=e,this.treeAdapter=this.parser.treeAdapter,this.posTracker=null,this.lastStartTagToken=null,this.lastFosterParentingLocation=null,this.currentToken=null}_setStartLocation(e){let t=null;this.lastStartTagToken&&((t=Object.assign({},this.lastStartTagToken.location)).startTag=this.lastStartTagToken.location),this.treeAdapter.setNodeSourceCodeLocation(e,t)}_setEndLocation(e,t){const n=this.treeAdapter.getNodeSourceCodeLocation(e);if(n&&t.location){const o=t.location,i=this.treeAdapter.getTagName(e);t.type===Tokenizer.END_TAG_TOKEN&&i===t.tagName?(n.endTag=Object.assign({},o),n.endLine=o.endLine,n.endCol=o.endCol,n.endOffset=o.endOffset):(n.endLine=o.startLine,n.endCol=o.startCol,n.endOffset=o.startOffset)}}_getOverriddenMethods(e,t){return{_bootstrap(n,o){t._bootstrap.call(this,n,o),e.lastStartTagToken=null,e.lastFosterParentingLocation=null,e.currentToken=null;const i=Mixin.install(this.tokenizer,LocationInfoTokenizerMixin);e.posTracker=i.posTracker,Mixin.install(this.openElements,LocationInfoOpenElementStackMixin,{onItemPop:function(t){e._setEndLocation(t,e.currentToken)}})},_runParsingLoop(n){t._runParsingLoop.call(this,n);for(let t=this.openElements.stackTop;t>=0;t--)e._setEndLocation(this.openElements.items[t],e.currentToken)},_processTokenInForeignContent(n){e.currentToken=n,t._processTokenInForeignContent.call(this,n)},_processToken(n){if(e.currentToken=n,t._processToken.call(this,n),n.type===Tokenizer.END_TAG_TOKEN&&(n.tagName===$.HTML||n.tagName===$.BODY&&this.openElements.hasInScope($.BODY)))for(let t=this.openElements.stackTop;t>=0;t--){const o=this.openElements.items[t];if(this.treeAdapter.getTagName(o)===n.tagName){e._setEndLocation(o,n);break}}},_setDocumentType(e){t._setDocumentType.call(this,e);const n=this.treeAdapter.getChildNodes(this.document),o=n.length;for(let t=0;t<o;t++){const o=n[t];if(this.treeAdapter.isDocumentTypeNode(o)){this.treeAdapter.setNodeSourceCodeLocation(o,e.location);break}}},_attachElementToTree(n){e._setStartLocation(n),e.lastStartTagToken=null,t._attachElementToTree.call(this,n)},_appendElement(n,o){e.lastStartTagToken=n,t._appendElement.call(this,n,o)},_insertElement(n,o){e.lastStartTagToken=n,t._insertElement.call(this,n,o)},_insertTemplate(n){e.lastStartTagToken=n,t._insertTemplate.call(this,n);const o=this.treeAdapter.getTemplateContent(this.openElements.current);this.treeAdapter.setNodeSourceCodeLocation(o,null)},_insertFakeRootElement(){t._insertFakeRootElement.call(this),this.treeAdapter.setNodeSourceCodeLocation(this.openElements.current,null)},_appendCommentNode(e,n){t._appendCommentNode.call(this,e,n);const o=this.treeAdapter.getChildNodes(n),i=o[o.length-1];this.treeAdapter.setNodeSourceCodeLocation(i,e.location)},_findFosterParentingLocation(){return e.lastFosterParentingLocation=t._findFosterParentingLocation.call(this),e.lastFosterParentingLocation},_insertCharacters(n){t._insertCharacters.call(this,n);const o=this._shouldFosterParentOnInsertion(),i=o&&e.lastFosterParentingLocation.parent||this.openElements.currentTmplContent||this.openElements.current,s=this.treeAdapter.getChildNodes(i),a=s[o&&e.lastFosterParentingLocation.beforeElement?s.indexOf(e.lastFosterParentingLocation.beforeElement)-1:s.length-1],r=this.treeAdapter.getNodeSourceCodeLocation(a);r?(r.endLine=n.location.endLine,r.endCol=n.location.endCol,r.endOffset=n.location.endOffset):this.treeAdapter.setNodeSourceCodeLocation(a,n.location)}}}}module.exports=LocationInfoParserMixin;