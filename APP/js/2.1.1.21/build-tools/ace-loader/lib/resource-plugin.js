"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,i){return t&&_defineProperties(e.prototype,t),i&&_defineProperties(e,i),e}var fs=require("fs"),path=require("path"),SingleEntryPlugin=require("webpack/lib/SingleEntryPlugin"),CUSTOM_THEME_PROP_GROUPS=require("./theme/customThemeStyles"),OHOS_THEME_PROP_GROUPS=require("./theme/ohosStyles"),FILE_EXT_NAME=[".js",".css",".jsx",".less",".sass",".scss",".md",".DS_Store",".hml"],red="[31m",reset="[39m",input="",output="",manifestFilePath="",shareThemePath="",internalThemePath="";function copyFile(e,t){try{if(fs.existsSync(e)){var i=path.join(t,"..");fs.existsSync(i)&&fs.statSync(i).isDirectory()||mkDir(i);var n=path.parse(e),r=addPageEntryObj(),s=n.dir+path.sep+n.name+".hml?entry";for(var a in r)if(r[a]===s)return;if(".json"===n.ext&&(n.dir===shareThemePath||n.dir===internalThemePath)&&themeFileBuild(e,t))return;var o=fs.createReadStream(e),c=fs.createWriteStream(t);o.pipe(c),o.on("close",function(){c.end()})}}catch(t){throw console.error(red,"Failed to build file ".concat(e,"."),reset),t.message}}function mkDir(e){var t=path.join(e,"..");fs.existsSync(t)&&!fs.statSync(t).isFile()||mkDir(t),fs.mkdirSync(e)}function circularFile(e,t,i){var n=path.join(e,i);fs.existsSync(n)&&n!==output&&fs.readdirSync(n).forEach(function(r){var s=path.join(n,r),a=fs.statSync(s);if(a.isFile()){var o=path.basename(s),c=path.extname(s);if(FILE_EXT_NAME.indexOf(c)<0&&".DS_Store"!==o){var l=path.join(t,i,path.basename(r));if(l===path.join(output,"manifest.json"))return;if(fs.existsSync(l)){var u=fs.statSync(l);u.isFile()&&a.size!==u.size&&copyFile(s,l)}else copyFile(s,l)}}else a.isDirectory()&&circularFile(e,t,path.join(i,r))})}var ResourcePlugin=function(){function e(t,i,n){_classCallCheck(this,e),input=t,output=i,manifestFilePath=n,shareThemePath=path.join(t,"../share/resources/styles"),internalThemePath=path.join(t,"resources/styles")}return _createClass(e,[{key:"apply",value:function(e){e.hooks.beforeCompile.tap("resource Copy",function(){circularFile(input,output,""),circularFile(input,output,"../share")}),e.hooks.normalModuleFactory.tap("OtherEntryOptionPlugin",function(){for(var t in addPageEntryObj(),entryObj){if(!e.options.entry[t])new SingleEntryPlugin("",entryObj[t],t).apply(e)}}),e.hooks.done.tap("copyManifest",function(){copyManifest(),fs.existsSync(path.join(output,"app.js"))&&fs.utimesSync(path.join(output,"app.js"),new Date,new Date)})}}]),e}();function copyManifest(){copyFile(manifestFilePath,path.join(output,"manifest.json"))}var entryObj={};function addPageEntryObj(){if(entryObj={},!fs.existsSync(manifestFilePath))throw Error("ERROR: missing manifest").message;var e=fs.readFileSync(manifestFilePath).toString(),t=JSON.parse(e).pages;if(void 0===t)throw Error("ERROR: missing pages").message;return t.forEach(function(e){var t=e;entryObj["./"+e]=input+"/"+t+".hml?entry"}),entryObj}function themeFileBuild(e,t){if(fs.existsSync(e)){var i=JSON.parse(fs.readFileSync(e)),n={};if(i&&i.style){n.style={};var r=i.style;return Object.keys(r).forEach(function(e){var t=CUSTOM_THEME_PROP_GROUPS[e],i=OHOS_THEME_PROP_GROUPS[e];i?n.style[i]=r[e]:t?n.style[t]=r[e]:n.style[e]=r[e]}),fs.writeFileSync(t,JSON.stringify(n,null,2)),!0}}return!1}module.exports=ResourcePlugin;