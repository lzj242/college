var path=require("path"),fs=require("fs"),md5=require("md5"),existsSync=fs.existsSync||path.existsSync,nodePaths=process.env.NODE_PATH?process.env.NODE_PATH.split(":"):[],cwd=process.cwd();function resolvePath(e,r){if("."===e[0])return findModuleMain(path.resolve(r,e));var n=findModuleMain(path.resolve(r,"node_modules",e));return n||""}function resolveRequire(e,r){var n=resolvePath(e,path.dirname(r));if(!n&&"."!==e[0]&&"/"!==e[0])for(var s=0;s<nodePaths.length&&!(n=findModuleMain(path.resolve(nodePaths[s],e)));s++);return n}function findModuleMain(e){var r="";function n(e){r||existsSync(e)&&(r=e)}".js"===path.extname(e)&&(e=e.replace(/\..+/,"")),n(e+".js");try{var s=JSON.parse(fs.readFileSync(e+"/package.json").toString());n(path.resolve(e,s.main+".js")),n(path.resolve(e,s.main))}catch(e){}return n(e+"/index.js"),r}nodePaths.push(cwd);var REQUIRE_REGEXP=/require\s*\(['"]([\w\/\.-]*)['"]\)/g;function parseAndReplaceRequire(e,r){r=r||".";var n={},s=[];return{code:e=e.replace(REQUIRE_REGEXP,function(e,a){var i;if((i=resolveRequire(path.resolve(cwd,r,a),"."))||(i=resolveRequire(a,".")),i){var t=md5(i);return n[t]=i,'browserifyRequire("'+t+'")'}return s.push({reason:'ERROR: Cannot find required module "'+a+'"'}),e}),requires:n,log:s}}exports.parseAndReplaceRequire=parseAndReplaceRequire;