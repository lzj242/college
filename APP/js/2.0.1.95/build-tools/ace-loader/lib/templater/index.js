var parse5=require("parse5"),parser=require("parse5/lib/parser"),tokenizer=require("parse5/lib/tokenizer"),validator=require("./validator");const EVENT_REGEXP=/^(@|on)/,TEXT_REGEXP=/^#/;function traverse(e,t,l,n){validator.checkTagName(t,l),checkAttrs(e,t,l,n),checkNodeChildren(e,t,l)}function checkAttrs(e,t,l,n){let o=t.attrs||[];for(let i=0;i<o.length;i++){let r=t.__location?{line:t.__location.line,col:t.__location.col}:{line:1,col:1},a=o[i].name,s=o[i].value;switch(a){case"if":validator.checkIf(s,l);break;case"elif":checkAttrElif(n,s,o,i,l);break;case"else":checkAttrElse(n,l);break;case"class":validator.checkClass(s,l);break;case"append":validator.checkAppend(s,l);break;case"id":validator.checkId(s,l);break;case"for":validator.checkFor(s,l,r);break;case"style":validator.checkStyle(s,l,r);break;default:a.match(EVENT_REGEXP)?validator.checkEvent(a,s,l):validator.checkAttr(e,a,s,l,t.tagName,r)}}}function checkAttrElif(e,t,l,n,o){if(e&&e.attrs)for(let l=0;l<e.attrs.length;l++){let n=e.attrs[l];if("if"===n.name&&(t="{{"+t.substr(2,t.length-4)+"&&!("+n.value.substr(2,n.value.length-4)+")}}",validator.checkElif(t,o)),"elif"===n.name){let e=n.value.indexOf("&&");t="{{"+t.substr(2,t.length-4)+"&&!("+n.value.substr(2,e-2)+")"+n.value.substr(e,n.value.length),validator.checkElif(t,o)}}l[n].value=t}function checkAttrElse(e,t){if(e&&e.attrs)for(let l=0;l<e.attrs.length;l++){let n=e.attrs[l];"if"===n.name&&validator.checkIf(n.value,t,!0),"elif"===n.name&&validator.checkElif(n.value,t,!0)}}function checkNodeChildren(e,t,l){let n=t.childNodes,o=l.result;if(n&&n.length>0){let i;for(let r=0;r<n.length;r++){if(r>1&&(i=n[r-2]),n[r].nodeName.match(TEXT_REGEXP)){if("#text"===n[r].nodeName&&n[r].value.trim()){let i=l.result;if(l.result=o,"option"===t.nodeName){validator.checkAttr(e,"content",n[r].value,l);continue}validator.checkAttr(e,"value",n[r].value,l),l.result=i}continue}let a={};l.result=a,o.children=o.children||[],o.children.push(a),traverse(e,n[r],l,i)}}l.result=o}function checkNode(e,t,l){let n=(t.tagName||"").toLowerCase(),o=t.selfClosing,i=validator.isSupportedSelfClosing(n);if(e.nodeInfo.tn&&n&&!e.nodeInfo.sc){let n=String(t.location.line)+String(t.location.col);(!i||n!==e.nodeInfo.pos&&t.type===tokenizer.START_TAG_TOKEN)&&(l.log.push({line:String(t.location.line)||1,column:String(t.location.col)||1,reason:"ERROR: The `"+e.nodeInfo.tn+"` tag must be closed."}),e.nodeInfo={})}n&&i&&(t.type!==tokenizer.START_TAG_TOKEN||o||(e.nodeInfo.tn=n,e.nodeInfo.sc=!1,e.nodeInfo.pos=String(t.location.line)+String(t.location.col)),t.type===tokenizer.END_TAG_TOKEN&&n===e.nodeInfo.tn&&(e.nodeInfo.sc=!0))}function hmlParse(e,t,l){let n=new parser(t),o=n._appendElement,i=n._insertElement;return n._insertElement=function(e,t){let n=(e.tagName||"").toLowerCase(),r=e.selfClosing,a=validator.isSupportedSelfClosing(n);r&&!a&&l.log.push({reason:"ERROR: The "+n+" tag cannot be self-closing."}),r&&n?o.apply(this,arguments):i.apply(this,arguments)},n.nodeInfo={},n._runParsingLoop=function(e,t){let o=void 0;for(;!this.stopped;){this._setupTokenizerCDATAMode();let e=this.tokenizer.getNextToken();if("EOF_TOKEN"!==e.type&&"WHITESPACE_CHARACTER_TOKEN"!==e.type&&(o=e),checkNode(n,e,l),e.type===tokenizer.HIBERNATION_TOKEN)break;if(this.skipNextNewLine&&(this.skipNextNewLine=!1,e.type===tokenizer.WHITESPACE_CHARACTER_TOKEN&&"\n"===e.chars[0])){if(1===e.chars.length)continue;e.chars=e.chars.substr(1)}if(this._processInputToken(e),t&&this.pendingScript)break}if("END_TAG_TOKEN"!==o.type&&"COMMENT_TOKEN"!==o.type&&l.log.push({line:String(o.location.line)||1,column:String(o.location.col)||1,reason:"ERROR: HML file content is invalid. Please check it."}),t&&this.pendingScript){let e=this.pendingScript;return this.pendingScript=null,void t(e)}e&&e()},n.parseFragment(e)}exports.parse=function(e,t,l){let n={result:{},deps:[],log:[]},o=hmlParse(e,{treeAdapter:parse5.treeAdapters.default,locationInfo:!0},n);if(!o||!o.childNodes)return n.log.push({reason:"ERROR: Failed to parse the HML file."}),void t(null,{jsonTemplate:n.result,deps:n.deps,log:n.log});let i=[];if(o.childNodes.forEach(function(e){"#"!==e.nodeName.charAt(0)&&i.push(e)}),1===i.length)traverse(l,i[0],n);else{let e=0===i.length?"ERROR: Invalid root node.":"ERROR:  At least one root node is required.";n.log.push({reason:e,line:1,column:1}),t(null,{jsonTemplate:n.result,deps:n.deps,log:n.log})}t(null,{jsonTemplate:n.result,deps:n.deps,log:n.log})};