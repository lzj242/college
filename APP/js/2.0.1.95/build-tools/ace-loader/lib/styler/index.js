"use strict";var css=require("css"),util=require("./lib/util"),validateItem=require("./lib/validator").validate,fs=require("fs"),path=require("path"),SELECTOR_MATCHER=/^[\.#]?[A-Za-z0-9_\-:]+$/,DESCENDANT_SELECTOR_MATCHER=/^([.#]?[A-Za-z0-9_-]+(\s+|\s*>\s*))+([.#]?[A-Za-z0-9_\-:]+)$/,IMPORT_MATCHER=/(['"]([^()]+?)['"])|(['"]([^()]+?)['"]\s+(only|not)?\s?(screen)?\s?((and|or|,|not|landscape)?\s?[(]([^()])+[)]\s*)+)/g,LENGTH_REGEXP=/^[-+]?\d*\.?\d+(\S*)$/;function expand(e,t,o){if("border"===t)e.value.forEach(function(e){if("Width"===e.type||"Color"===e.type){const i=[t+"Top"+e.type,t+"Right"+e.type,t+"Bottom"+e.type,t+"Left"+e.type];util.splitAttr(o,e.value,i)}else o[t+e.type]=e.value});else if(["borderTop","borderRight","borderBottom","borderLeft"].includes(t))e.value.forEach(function(e){o[t+e.type]=e.value});else if("margin"===t||"padding"===t){const i=[t+"Top",t+"Right",t+"Bottom",t+"Left"];util.splitAttr(o,e.value,i)}else"borderWidth"===t?util.splitAttr(o,e.value,["borderTopWidth","borderRightWidth","borderBottomWidth","borderLeftWidth"]):"borderColor"===t?util.splitAttr(o,e.value,["borderTopColor","borderRightColor","borderBottomColor","borderLeftColor"]):"gridGap"===t&&util.splitAttr(o,e.value,["gridRowsGap","gridColumnsGap"])}function flexExpand(e,t){for(let o=0;o<e.declarations.length;o++){let i=e.declarations[o];if("flex"===i.property){let n=i.value.split(/\s+/);e.declarations.splice(o,1),1===n.length?checkFlexOne(e,t,i,n,o):2===n.length?checkFlexTwo(e,t,i,n,o):3===n.length?checkFlexThree(e,t,i,n,o):t.push({line:i.position.start.line,column:i.position.start.column,reason:"ERROR: Value `"+i.value+"` of the `"+i.property+"` attribute is incorrect."})}}}function getUnit(e){let t=(e=e.toString().trim()).match(LENGTH_REGEXP);if(t){let e=t[1];if(!e)return"none";if("px"===e)return"px"}return null}function checkFlexOne(e,t,o,i,n){["none","auto","initial"].includes(i[0])?e.declarations.splice(n,0,{type:"declaration",property:"flex",value:i[0],position:o.position}):"px"===getUnit(i[0])?e.declarations.splice(n,0,{type:"declaration",property:"flex-basis",value:i[0],position:o.position}):"none"===getUnit(i[0])?e.declarations.splice(n,0,{type:"declaration",property:"flex-grow",value:i[0],position:o.position}):t.push({line:o.position.start.line,column:o.position.start.column,reason:"ERROR: Value `"+o.value+"` of the `"+o.property+"` attribute is incorrect.It must be a number, a number with unit `px`, none, auto, or initial."})}function checkFlexTwo(e,t,o,i,n){"none"===getUnit(i[0])?(e.declarations.splice(n,0,{type:"declaration",property:"flex-grow",value:i[0],position:o.position}),"px"===getUnit(i[1])?e.declarations.splice(n,0,{type:"declaration",property:"flex-basis",value:i[1],position:o.position}):"none"===getUnit(i[1])?e.declarations.splice(n,0,{type:"declaration",property:"flex-shrink",value:i[1],position:o.position}):t.push({line:o.position.start.line,column:o.position.start.column,reason:"ERROR: Value `"+o.value+"` of the `"+o.property+"` attribute is incorrect. Value `"+i[1]+"` must be a number or a number with unit `px`."})):t.push({line:o.position.start.line,column:o.position.start.column,reason:"ERROR: Value `"+o.value+"` of the `"+o.property+"` attribute is incorrect. Value `"+i[0]+"` must be a number."})}function checkFlexThree(e,t,o,i,n){"none"===getUnit(i[0])&&"none"===getUnit(i[1])&&"px"===getUnit(i[2])?(e.declarations.splice(n,0,{type:"declaration",property:"flex-grow",value:i[0],position:o.position}),e.declarations.splice(n,0,{type:"declaration",property:"flex-shrink",value:i[1],position:o.position}),e.declarations.splice(n,0,{type:"declaration",property:"flex-basis",value:i[2],position:o.position})):t.push({line:o.position.start.line,column:o.position.start.column,reason:"ERROR: Value `"+o.value+"` of the `"+o.property+"` attribute is incorrect. It must be in the format of (1, 1, 1px)."})}function parse(e,t,o){var i,n,r={},a=[];(i=css.parse(e,{silent:!0})).stylesheet.parsingErrors&&i.stylesheet.parsingErrors.length&&(n=i.stylesheet.parsingErrors).forEach(function(e){a.push({line:e.line,column:e.column,reason:e.toString().replace("Error","ERROR")})}),i&&"stylesheet"===i.type&&i.stylesheet&&i.stylesheet.rules&&i.stylesheet.rules.length&&i.stylesheet.rules.forEach(function(e){var t=e.type,i={},n=[];if("rule"===t)e.declarations&&e.declarations.length&&(flexExpand(e,n),e.declarations.forEach(function(e){var t,o,r,a;"declaration"===e.type&&(t=e.property,o=e.value,a=util.hyphenedToCamelCase(t),(r=validateItem(a,o)).value&&-1!==Object.values(util.SPLECIAL_ATTR).indexOf(a)&&expand(r,a,i),"number"!=typeof r.value&&"string"!=typeof r.value||Object.values(util.SPLECIAL_ATTR).includes(a)||(i[a]=r.value),r.log&&(r.log.line=e.position.start.line,r.log.column=e.position.start.column,n.push(r.log)))}),e.selectors.forEach(function(t){if(t.match(SELECTOR_MATCHER)||t.match(DESCENDANT_SELECTOR_MATCHER)){var o=t,n=o.indexOf(":");if(n>-1){var l=o.slice(n);o=o.slice(0,n);var s={};Object.keys(i).forEach(function(e){s[e+l]=i[e]}),i=s}Object.keys(i).forEach(function(e){if(0===e.indexOf("transition")&&"transition"!==e){var t=e.replace("transition","");t=t[0].toLowerCase()+t.slice(1),r["@TRANSITION"]=r["@TRANSITION"]||{},r["@TRANSITION"][o]=r["@TRANSITION"][o]||{},r["@TRANSITION"][o][t]=i[e]}r[o]=r[o]||{},r[o][e]=i[e]})}else a.push({line:e.position.start.line,column:e.position.start.column,reason:"ERROR: The `"+t+"` selector is not supported."})}),a=a.concat(n));else if("font-face"===t)e.declarations&&e.declarations.length&&(e.declarations.forEach(function(e){if("declaration"===e.type){var t=util.hyphenedToCamelCase(e.property),o=e.value;"fontFamily"===t&&"\"'".indexOf(o[0])>-1&&(o=o.slice(1,o.length-1)),i[t]=o}}),r["@FONT-FACE"]||(r["@FONT-FACE"]=[]),r["@FONT-FACE"].push(i));else if("import"===t)parseImport(o,e,r,a);else if("keyframes"===t){r["@KEYFRAMES"]||(r["@KEYFRAMES"]={});var l=e.name;r["@KEYFRAMES"][l]=[],e.keyframes&&e.keyframes.length&&(e.keyframes.forEach(function(e){if("keyframe"===e.type){if(e.declarations&&e.declarations.length&&e.declarations.forEach(function(e){var t,o,r,a;"declaration"===e.type&&(t=e.property,o=e.value,a=util.hyphenedToCamelCase(t),"number"!=typeof(r=validateItem(a,o)).value&&"string"!=typeof r.value||(i[a]=r.value),r.log&&(r.log.line=e.position.start.line,r.log.column=e.position.start.column,n.push(r.log)))}),"from"===e.values[0]){var t={};Object.keys(i).forEach(function(e){t[e]=i[e]}),t.time=0,r["@KEYFRAMES"][l].push(t)}if("to"===e.values[0]){t={};Object.keys(i).forEach(function(e){t[e]=i[e]}),t.time=100,r["@KEYFRAMES"][l].push(t)}}}),a=a.concat(n))}else if("media"===t){r["@MEDIA"]||(r["@MEDIA"]=[]);var s=e.media,p={};p.condition=s,e.rules&&e.rules.length&&e.rules.forEach(function(e){i={},"import"===e.type&&parseImport(o,e,p,a),e.declarations&&e.declarations.length&&(e.declarations.forEach(function(e){var t,o,r,a;"declaration"===e.type&&(t=e.property,o=e.value,a=util.hyphenedToCamelCase(t),(r=validateItem(a,o)).value&&-1!==Object.values(util.SPLECIAL_ATTR).indexOf(a)&&expand(r,a,i),"number"!=typeof r.value&&"string"!=typeof r.value||Object.values(util.SPLECIAL_ATTR).includes(a)||(i[a]=r.value),r.log&&(r.log.line=e.position.start.line,r.log.column=e.position.start.column,n.push(r.log)))}),e.selectors.forEach(function(t){if(t.match(SELECTOR_MATCHER)||t.match(DESCENDANT_SELECTOR_MATCHER)){var o=t,n=o.indexOf(":");if(n>-1){var r=o.slice(n);o=o.slice(0,n);var l={};Object.keys(i).forEach(function(e){l[e+r]=i[e]}),i=l}Object.keys(i).forEach(function(e){if(0===e.indexOf("transition")&&"transition"!==e){var t=e.replace("transition","");t=t[0].toLowerCase()+t.slice(1),p["@TRANSITION"]=p["@TRANSITION"]||{},p["@TRANSITION"][o]=p["@TRANSITION"][o]||{},p["@TRANSITION"][o][t]=i[e]}p[o]=p[o]||{},p[o][e]=i[e]})}else a.push({line:e.position.start.line,column:e.position.start.column,reason:"ERROR: The `"+t+"` selector is not supported."})}),a=a.concat(n))}),r["@MEDIA"].push(p)}}),t(n,{jsonStyle:r,log:a})}function parseImport(e,t,o,i){if(!e)return;let n,r=t.import,a="",l="";if(r.match(IMPORT_MATCHER)){n=r.match(/['"]([^()]+?)['"]/)[1],a=r.replace(n,"").replace(/['"]/g,"")}/^(\.)|(\.\.)\//.test(n)&&(e=e.substring(0,e.lastIndexOf(path.sep)+1),n=path.resolve(e,n)),fs.existsSync(n)?(l=fs.readFileSync(n).toString(),0!==a.length&&(l="@media "+a+"{\n"+l+"\n}"),parse(l,(e,t)=>{if(e)throw e;o=Object.assign(o,t.jsonStyle)},n)):i.push({line:t.position.start.line,column:t.position.start.column,reason:"ERROR: no such file or directory, open "+n})}function validate(e,t){var o,i=[];try{e=JSON.parse(JSON.stringify(e))}catch(t){o=t,e={}}Object.keys(e).forEach(function(t){var o=e[t];Object.keys(o).forEach(function(e){var t=o[e],n=validateItem(e,t);"number"==typeof n.value||"string"==typeof n.value?o[e]=n.value:delete o[e],n.log&&i.push(n.log)})}),t(o,{jsonStyle:e,log:i})}module.exports={parse:parse,validate:validate,validateItem:validateItem,util:util,expand:expand,getUnit:getUnit};