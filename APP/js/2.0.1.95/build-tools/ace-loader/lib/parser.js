"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.parseFragment=parseFragment,exports.extractBlocks=extractBlocks,exports.parseTemplate=parseTemplate,exports.parseStyle=parseStyle,exports.parseScript=parseScript;var _parse=_interopRequireDefault(require("parse5")),_blocker=_interopRequireDefault(require("weex-transformer/lib/blocker")),_templater=_interopRequireDefault(require("./templater")),_styler=_interopRequireDefault(require("./styler")),_scripter=_interopRequireDefault(require("./scripter")),_validator=require("./templater/validator"),_util=require("./util");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function getAttribute(e,t){if(e.attrs)for(var r,a=e.attrs.length;a--;)if((r=e.attrs[a]).name===t)return r.value}function extractDependencies(e,t){e.childNodes&&e.childNodes.forEach(function(e){(0,_validator.checkTagName)(e,{result:{},deps:t,log:[]}),extractDependencies(e,t)})}function parseFragment(e){var t={deps:[],element:[],template:[],style:[],script:[],data:[],config:[]};return _parse.default.parseFragment(e,{locationInfo:!0}).childNodes.forEach(function(e){var r;if("script"===e.tagName?"data"!==(r=getAttribute(e,"type"))&&"config"!==r&&(r="script"):r=e.tagName,"we-element"===r&&(console.warn('<we-element name="'.concat(getAttribute(e,"name"),'"> is deprecated, please use <element> instead.')),r="element"),t[r]){var a=getAttribute(e,"name"),n=getAttribute(e,"src"),i=getAttribute(e,"lang");if(t[r].push({name:a,src:n,lang:i,node:e}),"template"===r){var s=[];extractDependencies(e.content,s),t.deps=s}}}),t}function extractBlocks(e,t){return new Promise(function(r,a){_blocker.default.format(e,function(e,n){e?a(e):r(n[t])})})}function parseTemplate(e,t){return new Promise(function(r,a){_templater.default.parse(e,function(e,t){if(e)a(e);else{var n=JSON.stringify(t.jsonTemplate,_util.stringifyFunction,"  ");n=n.replace(_util.FUNC_START_REG,"").replace(_util.FUNC_END_REG,""),r({parsed:n,log:t.log})}},t)})}function parseStyle(e,t){return new Promise(function(r,a){_styler.default.parse(e,function(e,t){if(e)a(e);else{var n=JSON.stringify(t.jsonStyle,null,2);r({parsed:n,log:t.log})}},t)})}function parseScript(e){return new Promise(function(t,r){t({parsed:_scripter.default.fix(e)})})}