"use strict";const unicode=require("../common/unicode"),ERR=require("../common/error-codes"),$=unicode.CODE_POINTS,DEFAULT_BUFFER_WATERLINE=65536;class Preprocessor{constructor(){this.html=null,this.pos=-1,this.lastGapPos=-1,this.lastCharPos=-1,this.gapStack=[],this.skipNextNewLine=!1,this.lastChunkWritten=!1,this.endOfChunkHit=!1,this.bufferWaterline=DEFAULT_BUFFER_WATERLINE}_err(){}_addGap(){this.gapStack.push(this.lastGapPos),this.lastGapPos=this.pos}_processSurrogate(t){if(this.pos!==this.lastCharPos){const s=this.html.charCodeAt(this.pos+1);if(unicode.isSurrogatePair(s))return this.pos++,this._addGap(),unicode.getSurrogatePairCodePoint(t,s)}else if(!this.lastChunkWritten)return this.endOfChunkHit=!0,$.EOF;return this._err(ERR.surrogateInInputStream),t}dropParsedChunk(){this.pos>this.bufferWaterline&&(this.lastCharPos-=this.pos,this.html=this.html.substring(this.pos),this.pos=0,this.lastGapPos=-1,this.gapStack=[])}write(t,s){this.html?this.html+=t:this.html=t,this.lastCharPos=this.html.length-1,this.endOfChunkHit=!1,this.lastChunkWritten=s}insertHtmlAtCurrentPos(t){this.html=this.html.substring(0,this.pos+1)+t+this.html.substring(this.pos+1,this.html.length),this.lastCharPos=this.html.length-1,this.endOfChunkHit=!1}advance(){if(this.pos++,this.pos>this.lastCharPos)return this.endOfChunkHit=!this.lastChunkWritten,$.EOF;let t=this.html.charCodeAt(this.pos);if(this.skipNextNewLine&&t===$.LINE_FEED)return this.skipNextNewLine=!1,this._addGap(),this.advance();if(t===$.CARRIAGE_RETURN)return this.skipNextNewLine=!0,$.LINE_FEED;return this.skipNextNewLine=!1,unicode.isSurrogate(t)&&(t=this._processSurrogate(t)),t>31&&t<127||t===$.LINE_FEED||t===$.CARRIAGE_RETURN||t>159&&t<64976||this._checkForProblematicCharacters(t),t}_checkForProblematicCharacters(t){unicode.isControlCodePoint(t)?this._err(ERR.controlCharacterInInputStream):unicode.isUndefinedCodePoint(t)&&this._err(ERR.noncharacterInInputStream)}retreat(){this.pos===this.lastGapPos&&(this.lastGapPos=this.gapStack.pop(),this.pos--),this.pos--}}module.exports=Preprocessor;